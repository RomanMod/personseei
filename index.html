<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ò–≥—Ä–∞ "–£–≥–∞–¥–∞–π –ª–∏—á–Ω–æ—Å—Ç—å" - Telegram Mini App</title>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-TQ5F8JW26S"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-TQ5F8JW26S');
    </script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: #1C2526; /* Space Gray Night */
            color: #E8ECEF;
            transition: all 0.3s ease;
        }

        body.day {
            background: #F5F5F7; /* Day theme */
            color: #1C2526;
        }

        .container {
            max-width: 600px;
            padding: 20px;
            text-align: center;
        }

        .display {
            width: 100%;
            height: 300px;
            background: #2C3539;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .display img {
            max-width: 100%;
            max-height: 100%;
            display: none;
        }

        .display .loading {
            font-size: 24px;
            color: #E8ECEF;
        }

        .arrow {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: #4A5859;
            border: none;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            color: #E8ECEF;
        }

        .arrow:hover {
            background: #5A6A6B;
        }

        button, input[type="submit"] {
            background: #4A5859;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            color: #E8ECEF;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
            transition: background 0.2s;
        }

        button:hover, input[type="submit"]:hover {
            background: #5A6A6B;
        }

        .radio-group {
            margin: 20px 0;
        }

        .radio-group label {
            margin: 0 10px;
            font-size: 16px;
        }

        input[type="radio"]:checked + label {
            color: #00FF00; /* Green for correct answers */
        }

        .correct {
            color: #00FF00 !important;
        }

        .wrong {
            color: #FF0000 !important;
        }

        .info, .stats {
            margin-top: 20px;
            font-size: 18px;
        }

        select {
            background: #4A5859;
            border: none;
            padding: 10px;
            border-radius: 8px;
            color: #E8ECEF;
            margin: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="playerName">–ò–≥—Ä–∞ "–£–≥–∞–¥–∞–π –ª–∏—á–Ω–æ—Å—Ç—å"</h1>
        <div>
            <button onclick="toggleTheme()">–¢–µ–º–∞: –ù–æ—á—å</button>
            <select id="language" onchange="changeLanguage()">
                <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                <option value="uk">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</option>
                <option value="en">English</option>
                <option value="alien">üëΩ –ò–Ω–æ–ø–ª–∞–Ω–µ—Ç–Ω—ã–π</option>
            </select>
            <select id="difficulty" onchange="changeDifficulty()">
                <option value="easy">–ü–æ–ø—Ä–æ—â–µ</option>
                <option value="hard">–ü—Ä–æ—Å—Ç–æ</option>
            </select>
        </div>
        <div class="display">
            <div class="loading" id="loading">–ó–∞–≥—Ä—É–∑–∫–∞: 0%</div>
            <img id="personImage" alt="Person Image">
            <button class="arrow" onclick="loadNewPerson()">‚û°Ô∏è</button>
        </div>
        <div class="radio-group" id="statusGroup">
            <input type="radio" name="status" id="alive" value="alive">
            <label for="alive" id="aliveLabel">–ñ–∏–≤</label>
            <input type="radio" name="status" id="dead" value="dead">
            <label for="dead" id="deadLabel">–ú—ë—Ä—Ç–≤</label>
        </div>
        <div class="radio-group" id="genderGroup" style="display: none;">
            <input type="radio" name="gender" id="male" value="male">
            <label for="male" id="maleLabel">–ú—É–∂—á–∏–Ω–∞</label>
            <input type="radio" name="gender" id="female" value="female">
            <label for="female" id="femaleLabel">–ñ–µ–Ω—â–∏–Ω–∞</label>
        </div>
        <input type="submit" value="–ü—Ä–æ–≤–µ—Ä–∏—Ç—å" onclick="checkAnswers()">
        <div class="info" id="personInfo"></div>
        <div class="stats" id="stats">–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: 0 | –í—Å–µ–≥–æ –ø–æ–ø—ã—Ç–æ–∫: 0</div>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        // Telegram Web Apps API
        window.Telegram.WebApp.ready();
        const playerName = window.Telegram.WebApp.initDataUnsafe.user?.first_name || "–ò–≥—Ä–æ–∫";
        document.getElementById("playerName").textContent = `–ò–≥—Ä–∞ "–£–≥–∞–¥–∞–π –ª–∏—á–Ω–æ—Å—Ç—å", ${playerName}`;

        // –ü–µ—Ä–µ–≤–æ–¥—ã
        const translations = {
            ru: {
                title: "–ò–≥—Ä–∞ '–£–≥–∞–¥–∞–π –ª–∏—á–Ω–æ—Å—Ç—å'",
                alive: "–ñ–∏–≤",
                dead: "–ú—ë—Ä—Ç–≤",
                male: "–ú—É–∂—á–∏–Ω–∞",
                female: "–ñ–µ–Ω—â–∏–Ω–∞",
                check: "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å",
                theme: "–¢–µ–º–∞: –ù–æ—á—å",
                themeDay: "–¢–µ–º–∞: –î–µ–Ω—å",
                stats: "–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: {{correct}} | –í—Å–µ–≥–æ –ø–æ–ø—ã—Ç–æ–∫: {{total}}"
            },
            uk: {
                title: "–ì—Ä–∞ '–í–≥–∞–¥–∞–π –æ—Å–æ–±—É'",
                alive: "–ñ–∏–≤–∏–π",
                dead: "–ú–µ—Ä—Ç–≤–∏–π",
                male: "–ß–æ–ª–æ–≤—ñ–∫",
                female: "–ñ—ñ–Ω–∫–∞",
                check: "–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏",
                theme: "–¢–µ–º–∞: –ù—ñ—á",
                themeDay: "–¢–µ–º–∞: –î–µ–Ω—å",
                stats: "–ü—Ä–∞–≤–∏–ª—å–Ω–∏—Ö –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π: {{correct}} | –í—Å—å–æ–≥–æ —Å–ø—Ä–æ–±: {{total}}"
            },
            en: {
                title: "Guess the Person Game",
                alive: "Alive",
                dead: "Dead",
                male: "Male",
                female: "Female",
                check: "Check",
                theme: "Theme: Night",
                themeDay: "Theme: Day",
                stats: "Correct answers: {{correct}} | Total attempts: {{total}}"
            },
            alien: {
                title: "üëΩ …¢·¥Ä·¥ç·¥á '…¢·¥ú·¥áÍú±Íú± ·¥õ ú·¥á ·¥ò·¥á ÄÍú±·¥è…¥'",
                alive: "üõ∏ ·¥Ä ü…™·¥†·¥á",
                dead: "üí´ ·¥Ö·¥á·¥Ä·¥Ö",
                male: "üëæ ·¥ç·¥Ä ü·¥á",
                female: "üåå Íú∞·¥á·¥ç·¥Ä ü·¥á",
                check: "üîç ·¥Ñ ú·¥á·¥Ñ·¥ã",
                theme: "üåë ·¥õ ú·¥á·¥ç·¥á: …¥…™…¢ ú·¥õ",
                themeDay: "‚òÄÔ∏è ·¥õ ú·¥á·¥ç·¥á: ·¥Ö·¥Ä è",
                stats: "‚úÖ ·¥Ñ·¥è Ä Ä·¥á·¥Ñ·¥õ: {{correct}} | üî¢ ·¥õ·¥è·¥õ·¥Ä ü: {{total}}"
            }
        };

        let currentLang = "ru";
        let difficulty = "easy";
        let correctAnswers = 0;
        let totalAttempts = 0;
        let currentPerson = null;
        let isNight = true;

        // –°–º–µ–Ω–∞ —è–∑—ã–∫–∞
        function changeLanguage() {
            currentLang = document.getElementById("language").value;
            updateUIText();
        }

        // –°–º–µ–Ω–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
        function changeDifficulty() {
            difficulty = document.getElementById("difficulty").value;
            document.getElementById("genderGroup").style.display = difficulty === "hard" ? "block" : "none";
            document.getElementById("personImage").style.display = difficulty === "easy" ? "block" : "none";
            loadNewPerson();
        }

        // –°–º–µ–Ω–∞ —Ç–µ–º—ã
        function toggleTheme() {
            isNight = !isNight;
            document.body.classList.toggle("day", !isNight);
            document.querySelector("button[onclick='toggleTheme()']").textContent = 
                isNight ? translations[currentLang].theme : translations[currentLang].themeDay;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        function updateUIText() {
            const t = translations[currentLang];
            document.getElementById("playerName").textContent = `${t.title}, ${playerName}`;
            document.getElementById("aliveLabel").textContent = t.alive;
            document.getElementById("deadLabel").textContent = t.dead;
            document.getElementById("maleLabel").textContent = t.male;
            document.getElementById("femaleLabel").textContent = t.female;
            document.querySelector("input[type='submit']").value = t.check;
            document.querySelector("button[onclick='toggleTheme()']").textContent = 
                isNight ? t.theme : t.themeDay;
            updateStats();
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞ —á–µ—Ä–µ–∑ Wikipedia API
        async function loadNewPerson() {
            document.getElementById("personInfo").innerHTML = "";
            document.getElementById("loading").style.display = "block";
            document.getElementById("personImage").style.display = "none";
            resetRadioButtons();

            let progress = 0;
            const loadingInterval = setInterval(() => {
                progress += 10;
                document.getElementById("loading").textContent = `–ó–∞–≥—Ä—É–∑–∫–∞: ${progress}%`;
                if (progress >= 100) clearInterval(loadingInterval);
            }, 200);

            try {
                // –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–∑ —Å–ø–∏—Å–∫–∞ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –ª–∏—á–Ω–æ—Å—Ç–µ–π
                const response = await fetch(
                    difficulty === "hard"
                        ? `https://${currentLang}.wikipedia.org/w/api.php?action=query&list=mostviewed&format=json&pvimetric=pageviews&pvilimit=50&origin=*`
                        : `https://${currentLang}.wikipedia.org/w/api.php?action=query&list=random&rnnamespace=0&rnlimit=1&format=json&origin=*`
                );
                const data = await response.json();

                let pageId;
                if (difficulty === "hard") {
                    const articles = data.query.mostviewed.filter(a => a.ns === 0 && !a.title.includes(":")); // –¢–æ–ª—å–∫–æ —Å—Ç–∞—Ç—å–∏ –æ –ª—é–¥—è—Ö
                    pageId = articles[Math.floor(Math.random() * articles.length)].id;
                } else {
                    pageId = data.query.random[0].id;
                }

                // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                const pageResponse = await fetch(
                    `https://${currentLang}.wikipedia.org/w/api.php?action=query&prop=pageimages|info&inprop=url&piprop=original&format=json&pageids=${pageId}&origin=*`
                );
                const pageData = await pageResponse.json();
                const page = pageData.query.pages[pageId];

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                let imageUrl = page.original?.source;
                if (!imageUrl || !await isValidImage(imageUrl)) {
                    console.log("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –∏—â–µ–º –Ω–æ–≤–æ–µ...");
                    clearInterval(loadingInterval);
                    document.getElementById("loading").textContent = "–û—à–∏–±–∫–∞, –∏—â–µ–º –Ω–æ–≤–æ–µ —Ñ–æ—Ç–æ...";
                    return loadNewPerson(); // –ü–æ–≤—Ç–æ—Ä—è–µ–º –∑–∞–ø—Ä–æ—Å
                }

                // –ü–æ–ª—É—á–∞–µ–º –∫—Ä–∞—Ç–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ª–∏—á–Ω–æ—Å—Ç–∏
                const extractResponse = await fetch(
                    `https://${currentLang}.wikipedia.org/w/api.php?action=query&prop=extracts&exintro&explaintext&format=json&pageids=${pageId}&origin=*`
                );
                const extractData = await extractResponse.json();
                const extract = extractData.query.pages[pageId].extract;

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∏ –ø–æ–ª (—É–ø—Ä–æ—â—ë–Ω–Ω–æ, –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—Å—Ç–∞)
                const isAlive = !extract.includes("—É–º–µ—Ä") && !extract.includes("—Å–º–µ—Ä—Ç—å");
                const isMale = extract.includes("–º—É–∂—á–∏–Ω–∞") || extract.includes("–∞–∫—Ç—ë—Ä") || extract.includes("–ø–æ–ª–∏—Ç–∏–∫") || !extract.includes("–∂–µ–Ω—â–∏–Ω–∞");

                currentPerson = {
                    title: page.title,
                    image: imageUrl,
                    wikiUrl: page.fullurl,
                    isAlive,
                    isMale
                };

                document.getElementById("personImage").src = imageUrl;
                document.getElementById("personImage").style.display = difficulty === "easy" ? "block" : "none";
                document.getElementById("loading").style.display = "none";

                console.log("–ó–∞–≥—Ä—É–∂–µ–Ω —á–µ–ª–æ–≤–µ–∫:", currentPerson);
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", error);
                document.getElementById("loading").textContent = "–û—à–∏–±–∫–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞...";
                clearInterval(loadingInterval);
                setTimeout(loadNewPerson, 2000); // –ü–æ–≤—Ç–æ—Ä—è–µ–º —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        async function isValidImage(url) {
            try {
                const response = await fetch(url, { method: "HEAD" });
                const contentType = response.headers.get("content-type");
                return response.ok && contentType?.startsWith("image/");
            } catch {
                return false;
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤
        function checkAnswers() {
            if (!currentPerson) return;

            const statusAnswer = document.querySelector("input[name='status']:checked")?.value;
            const genderAnswer = document.querySelector("input[name='gender']:checked")?.value;

            let isStatusCorrect = false;
            let isGenderCorrect = true; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é true, –µ—Å–ª–∏ –ø–æ–ª –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è

            if (statusAnswer) {
                isStatusCorrect = (statusAnswer === "alive" && currentPerson.isAlive) || (statusAnswer === "dead" && !currentPerson.isAlive);
                document.getElementById(statusAnswer + "Label").classList.add(isStatusCorrect ? "correct" : "wrong");
                document.getElementById((statusAnswer === "alive" ? "dead" : "alive") + "Label").classList.add(isStatusCorrect ? "wrong" : "correct");
            }

            if (difficulty === "hard" && genderAnswer) {
                isGenderCorrect = (genderAnswer === "male" && currentPerson.isMale) || (genderAnswer === "female" && !currentPerson.isMale);
                document.getElementById(genderAnswer + "Label").classList.add(isGenderCorrect ? "correct" : "wrong");
                document.getElementById((genderAnswer === "male" ? "female" : "male") + "Label").classList.add(isGenderCorrect ? "wrong" : "correct");
            }

            const isCorrect = isStatusCorrect && isGenderCorrect;
            if (isCorrect) correctAnswers++;
            totalAttempts++;

            // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ GA4
            gtag("event", "check_answer", {
                event_category: "Game",
                event_label: isCorrect ? "Correct" : "Incorrect",
                value: isCorrect ? 1 : 0,
                difficulty,
                language: currentLang
            });

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            if (difficulty === "hard") {
                document.getElementById("personImage").style.display = "block";
            }
            document.getElementById("personInfo").innerHTML = `
                ${currentPerson.title}<br>
                <a href="${currentPerson.wikiUrl}" target="_blank">–°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–∞ –í–∏–∫–∏–ø–µ–¥–∏–∏</a>
            `;

            updateStats();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function updateStats() {
            const t = translations[currentLang];
            document.getElementById("stats").textContent = t.stats
                .replace("{{correct}}", correctAnswers)
                .replace("{{total}}", totalAttempts);
        }

        // –°–±—Ä–æ—Å —Ä–∞–¥–∏–æ–∫–Ω–æ–ø–æ–∫
        function resetRadioButtons() {
            document.querySelectorAll("input[type='radio']").forEach(input => {
                input.checked = false;
            });
            document.querySelectorAll(".radio-group label").forEach(label => {
                label.classList.remove("correct", "wrong");
            });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        loadNewPerson();
        updateUIText();
    </script>
</body>
</html>
