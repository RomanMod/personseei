<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>–í–∏–ø–∞–¥–∫–æ–≤–µ —Ñ–æ—Ç–æ –ª—é–¥–∏–Ω–∏ –∑ Wikidata</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f9f9f9;
            text-align: center;
            padding: 40px;
        }

        h1 {
            color: #333;
        }

        #person-image {
            display: block;
            max-width: 100%;
            max-height: 300px;
            width: auto;
            height: auto;
            border: 2px solid #999;
            border-radius: 10px;
            margin: 0 auto;
            opacity: 0;
            transition: opacity 0.5s ease-in;
        }

        #person-image.loaded {
            opacity: 1;
        }

        #person-name {
            margin-top: 15px;
            font-size: 1.5em;
            font-weight: bold;
        }

        #progress {
            margin-top: 20px;
            font-style: italic;
            color: #888;
        }

        #progress.error {
            color: red;
        }

        .btn-container {
            margin-top: 20px;
        }

        .btn-container button {
            margin: 5px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }

        .time-info {
            margin-top: 5px;
            font-size: 0.9em;
            color: #666;
        }

        .stats {
            margin-top: 20px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
            display: inline-block;
        }
    </style>
</head>
<body>

    <h1>–í–∏–ø–∞–¥–∫–æ–≤–∞ –ª—é–¥–∏–Ω–∞ –∑ Wikidata</h1>
    <img id="person-image" src="" alt="–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ª—é–¥–∏–Ω–∏">
    <div id="person-name"></div>
    <div id="progress">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>

    <div class="btn-container">
        <button onclick="loadPerson(true)">
            üéØ –°—É–ø–µ—Ä –≤–∏–ø–∞–¥–∫–æ–≤–æ (–ø–æ–≤—ñ–ª—å–Ω–æ)
        </button>
        <div id="time-slow" class="time-info"></div>
        
        <button onclick="loadSession()">
            ‚ö° –°–µ—Å—ñ—è (–∑–±–∞–ª–∞–Ω—Å–æ–≤–∞–Ω–∞ –≤–∏–ø–∞–¥–∫–æ–≤—ñ—Å—Ç—å)
        </button>
        <div id="time-fast" class="time-info"></div>
    </div>

    <div class="stats">
        <div>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è:</div>
        <div id="stats-slow">–ü–æ–≤—ñ–ª—å–Ω–∏–π —Ä–µ–∂–∏–º: -</div>
        <div id="stats-fast">–®–≤–∏–¥–∫–∏–π —Ä–µ–∂–∏–º: -</div>
    </div>

    <script>
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        const settings = {
            superRandomPeople: false, // ORDER BY RAND(), –≤—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞
            RandomPeople: true, // OFFSET –¥–ª—è –±–∞–ª–∞–Ω—Å–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏ —Å–ª—É—á–∞–π–Ω–æ—Å—Ç–∏
            dynamicOffset: true, // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π OFFSET
            maxOffset: 100, // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Å–¥–≤–∏–≥
            maxPeople: 100, // –ú–∞–∫—Å–∏–º—É–º –ª—é–¥–µ–π –≤ –∑–∞–ø—Ä–æ—Å–µ
            sessionPeople: 10, // –õ—é–¥–µ–π –∑–∞ —Å–µ—Å—Å–∏—é
            genderRatio: { male: 50, female: 50 }, // 50/50 –ø–æ–ª
            statusRatio: { alive: 50, deceased: 50 } // 50/50 —Å—Ç–∞—Ç—É—Å
        };

        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        const stats = {
            slow: { count: 0, totalTime: 0, lastTime: 0 },
            fast: { count: 0, totalTime: 0, lastTime: 0 }
        };

        function updateStats(mode, time) {
            stats[mode].count++;
            stats[mode].totalTime += time;
            stats[mode].lastTime = time;
            
            const avgTime = stats[mode].totalTime / stats[mode].count;
            document.getElementById(`stats-${mode}`).textContent = 
                `${mode === 'slow' ? '–ü–æ–≤—ñ–ª—å–Ω–∏–π' : '–®–≤–∏–¥–∫–∏–π'} —Ä–µ–∂–∏–º: ` +
                `–û—Å—Ç–∞–Ω–Ω—î: ${time.toFixed(0)}–º—Å, ` +
                `–°–µ—Ä–µ–¥–Ω—î: ${avgTime.toFixed(0)}–º—Å, ` +
                `–ó–∞–ø–∏—Ç—ñ–≤: ${stats[mode].count}`;
                
            document.getElementById(`time-${mode}`).textContent = 
                `–ß–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è: ${time.toFixed(0)}–º—Å`;
        }

        async function getCommonsImageUrl(fileName) {
            const start = performance.now();
            const response = await fetch(`https://commons.wikimedia.org/w/api.php?action=query&titles=File:${encodeURIComponent(fileName)}&prop=imageinfo&iiprop=url&format=json&origin=*`);
            const data = await response.json();
            const pages = data.query.pages;
            const page = pages Kazakhstan(1);
            console.log(`Commons API time: ${(performance.now() - start).toFixed(0)}ms`);
            return page.imageinfo ? page.imageinfo[0].url : null;
        }

        async function loadImageWithFallback(url, element) {
            return new Promise((resolve, reject) => {
                element.classList.remove('loaded');
                element.onerror = () => {
                    const proxyUrl = `https://images.weserv.nl/?url=${encodeURIComponent(url)}`;
                    element.onerror = () => {
                        element.src = 'https://via.placeholder.com/300';
                        reject(new Error('Fallback failed'));
                    };
                    element.src = proxyUrl;
                };
                element.onload = () => {
                    element.classList.add('loaded');
                    resolve();
                };
                element.src = url;
            });
        }

        async function fetchPersonData(useRandom = true, category = null) {
            const start = performance.now();
            let query;

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            const genderFilter = category?.gender === 'male' ? 'FILTER(?gender = wd:Q6581097)' :
                                category?.gender === 'female' ? 'FILTER(?gender = wd:Q6581072)' :
                                'FILTER(?gender IN (wd:Q6581097, wd:Q6581072))';
            const statusFilter = category?.status === 'alive' ? 'FILTER NOT EXISTS { ?person wdt:P570 ?deathDate }' :
                                category?.status === 'deceased' ? '?person wdt:P570 ?deathDate' :
                                'OPTIONAL { ?person wdt:P570 ?deathDate }';

            if (useRandom && settings.superRandomPeople) {
                query = `
                    SELECT ?person ?personLabel ?image ?country ?gender ?deathDate
                    WHERE {
                        ?person wdt:P31 wd:Q5;
                                wdt:P18 ?image;
                                wdt:P27 ?country;
                                wdt:P21 ?gender.
                        ${genderFilter}.
                        ${statusFilter}.
                        ?person rdfs:label ?personLabel.
                        FILTER (LANG(?personLabel) = "en").
                    }
                    ORDER BY RAND()
                    LIMIT 1
                `;
            } else {
                const offset = settings.dynamicOffset ? Math.floor(Math.random() * settings.maxOffset) : 0;
                query = `
                    SELECT ?person ?personLabel ?image ?country ?gender ?deathDate
                    WHERE {
                        ?person wdt:P31 wd:Q5;
                                wdt:P18 ?image;
                                wdt:P27 ?country;
                                wdt:P21 ?gender.
                        ${genderFilter}.
                        ${statusFilter}.
                        ?person rdfs:label ?personLabel.
                        FILTER (LANG(?personLabel) = "en").
                    }
                    OFFSET ${offset}
                    LIMIT ${settings.maxPeople}
                `;
            }

            const endpoint = 'https://query.wikidata.org/sparql';
            const url = `${endpoint}?query=${encodeURIComponent(query)}&format=json&nocache=${Date.now()}`;

            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 15000);

            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/sparql-results+json',
                        'User-Agent': 'SimplePhotoApp/1.0 (https://romanmod.github.io/personseei/; krv.mod@gmail.com)',
                    },
                    signal: controller.signal
                });

                clearTimeout(timeout);
                const data = await response.json();
                const list = data.results.bindings;

                console.log(`Wikidata query time: ${(performance.now() - start).toFixed(0)}ms (${useRandom ? 'random' : 'fast'})`);

                if (!list.length) throw new Error('No person found');

                if (useRandom) {
                    return list[0];
                } else {
                    const randomIndex = Math.floor(Math.random() * list.length);
                    return list[randomIndex];
                }
            } catch (error) {
                throw error;
            }
        }

        function updateUI({ personLabel, gender, deathDate }) {
            const progress = document.getElementById('progress');
            const personName = document.getElementById('person-name');
            progress.textContent = '–§–æ—Ç–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ!';
            progress.classList.remove('loading', 'error');
            const genderText = gender?.value.split('/').pop() === 'Q6581097' ? '–ß–æ–ª–æ–≤—ñ–∫' : '–ñ—ñ–Ω–∫–∞';
            const statusText = deathDate ? '–ú–µ—Ä—Ü' : '–ñ–∏–≤–∏–π';
            personName.textContent = `${personLabel.value} (${genderText}, ${statusText})`;
        }

        function handleError(errorMessage) {
            const progress = document.getElementById('progress');
            const personImage = document.getElementById('person-image');
            const personName = document.getElementById('person-name');

            progress.textContent = errorMessage;
            progress.classList.add('error');
            progress.classList.remove('loading');
            personImage.src = 'https://via.placeholder.com/300';
            personName.textContent = '–¢–µ—Å—Ç–æ–≤–∏–π –ø–µ—Ä—Å–æ–Ω–∞–∂';
        }

        async function loadPerson(useRandom = true, category = null) {
            const startTime = performance.now();
            const mode = useRandom ? 'slow' : 'fast';
            
            const progress = document.getElementById('progress');
            const personImage = document.getElementById('person-image');
            const personName = document.getElementById('person-name');

            progress.textContent = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...';
            progress.classList.add('loading');
            progress.classList.remove('error');
            personImage.src = '';
            personName.textContent = '';
            personImage.classList.remove('loaded');

            try {
                const person = await fetchPersonData(useRandom, category);
                if (!person) throw new Error('No person found');

                const fileName = decodeURIComponent(person.image.value.split('/').pop());
                const imageUrl = await getCommonsImageUrl(fileName);
                if (!imageUrl) throw new Error('Invalid image');

                await loadImageWithFallback(imageUrl, personImage);
                updateUI(person);
                
                const totalTime = performance.now() - startTime;
                updateStats(mode, totalTime);
            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞:', error.message);
                let message = '–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è';

                if (error.message.includes('Timeout')) {
                    message = '–¢–∞–π–º-–∞—É—Ç –∑–∞–ø–∏—Ç—É –¥–æ Wikidata';
                } else if (error.message.includes('HTTP 400')) {
                    message = '–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π SPARQL-–∑–∞–ø–∏—Ç';
                } else if (error.message.includes('No person found')) {
                    message = '–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –¥–∞–Ω–∏—Ö –ø—Ä–æ –ª—é–¥–∏–Ω—É';
                } else if (error.message.includes('Invalid image')) {
                    message = '–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è';
                }

                handleError(message);
                
                const totalTime = performance.now() - startTime;
                document.getElementById(`time-${mode}`).textContent = 
                    `–ü–æ–º–∏–ª–∫–∞ –ø—ñ—Å–ª—è ${totalTime.toFixed(0)}–º—Å`;
            }
        }

        async function loadSession() {
            let sessionCount = 0;
            const categories = [
                { gender: 'male', status: 'alive' },
                { gender: 'male', status: 'deceased' },
                { gender: 'female', status: 'alive' },
                { gender: 'female', status: 'deceased' }
            ];
            const sessionList = [];

            // –°–æ–±–∏—Ä–∞–µ–º –ø–æ 2.5 —á–µ–ª–æ–≤–µ–∫–∞ –∏–∑ –∫–∞–∂–¥–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–∏—Ç–æ–≥–æ 10: 3, 2, 3, 2)
            const counts = [3, 2, 3, 2]; // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Ä—Å–æ–Ω –¥–ª—è –∫–∞–∂–¥–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            for (let i = 0; i < categories.length; i++) {
                for (let j = 0; j < counts[i]; j++) {
                    try {
                        const person = await fetchPersonData(false, categories[i]);
                        sessionList.push(person);
                    } catch (error) {
                        console.error(`–û—à–∏–±–∫–∞ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ${categories[i].gender}/${categories[i].status}:`, error);
                        sessionList.push(null); // –ó–∞–ø–æ–ª–Ω—è–µ–º null –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
                    }
                }
            }

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ –æ—á–µ—Ä–µ–¥–∏
            for (const person of sessionList) {
                if (person) {
                    await loadPersonFromData(person);
                } else {
                    handleError('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ª—é–¥–∏–Ω—É –¥–ª—è —Ü—ñ—î—ó –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó');
                }
                sessionCount++;
                if (sessionCount < settings.sessionPeople) {
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
            }
            document.getElementById('progress').textContent = `–°–µ—Å—ñ—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ (${settings.sessionPeople} –æ—Å—ñ–±)`;
        }

        async function loadPersonFromData(person) {
            const startTime = performance.now();
            const mode = 'fast';
            const progress = document.getElementById('progress');
            const personImage = document.getElementById('person-image');
            const personName = document.getElementById('person-name');

            progress.textContent = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...';
            progress.classList.add('loading');
            progress.classList.remove('error');
            personImage.src = '';
            personName.textContent = '';
            personImage.classList.remove('loaded');

            try {
                const fileName = decodeURIComponent(person.image.value.split('/').pop());
                const imageUrl = await getCommonsImageUrl(fileName);
                if (!imageUrl) throw new Error('Invalid image');

                await loadImageWithFallback(imageUrl, personImage);
                updateUI(person);
                
                const totalTime = performance.now() - startTime;
                updateStats(mode, totalTime);
            } catch (error) {
                handleError(error.message);
                const totalTime = performance.now() - startTime;
                document.getElementById(`time-${mode}`).textContent = 
                    `–ü–æ–º–∏–ª–∫–∞ –ø—ñ—Å–ª—è ${totalTime.toFixed(0)}–º—Å`;
            }
        }

        window.onload = () => {
            loadSession();
        };
    </script>

</body>
</html>
