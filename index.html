<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guess Who - Telegram Mini App</title>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-TQ5F8JW26S"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-TQ5F8JW26S');
    </script>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #1C2526; /* Space gray background */
            color: #E8ECEF;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        body.light {
            background-color: #E8ECEF;
            color: #1C2526;
        }

        .container {
            max-width: 600px;
            width: 100%;
            padding: 20px;
            text-align: center;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .settings select, .settings button {
            padding: 10px;
            margin: 0 5px;
            border: none;
            border-radius: 5px;
            background-color: #2E2E2E;
            color: #E8ECEF;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .settings select:hover, .settings button:hover {
            background-color: #3E3E3E;
        }

        .settings button {
            background-color: #4CAF50;
        }

        .settings button:hover {
            background-color: #45a049;
        }

        .display {
            width: 100%;
            height: 300px;
            background-color: #2E2E2E;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .display img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            display: none;
        }

        .display .loading {
            font-size: 24px;
            color: #E8ECEF;
        }

        .next-arrow {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 30px;
            color: #E8ECEF;
            cursor: pointer;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 50%;
            transition: background-color 0.3s;
        }

        .next-arrow:hover {
            background-color: rgba(0, 0, 0, 0.8);
        }

        .questions {
            margin-bottom: 20px;
        }

        .questions label {
            margin: 0 10px;
        }

        .questions input[type="radio"] {
            margin-right: 5px;
        }

        .questions .correct {
            color: #4CAF50;
            font-weight: bold;
        }

        .questions .incorrect {
            color: #FF5252;
        }

        .check-button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background-color: #4CAF50;
            color: #E8ECEF;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .check-button:hover {
            background-color: #45a049;
        }

        .result {
            margin-top: 20px;
            display: none;
        }

        .result a {
            color: #4CAF50;
            text-decoration: none;
        }

        .result a:hover {
            text-decoration: underline;
        }

        .statistics {
            margin-top: 20px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="settings">
                <select id="language">
                    <option value="uk">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</option>
                    <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                    <option value="en" selected>English</option>
                    <option value="alien">üëæ Alien</option>
                </select>
                <select id="difficulty">
                    <option value="simple">Simple</option>
                    <option value="very-simple" selected>Very Simple</option>
                </select>
                <button id="theme-toggle">üåô Night</button>
            </div>
            <span id="player-name">Player</span>
        </div>
        <div class="display" id="display">
            <div class="loading" id="loading">Loading: 0%</div>
            <img id="person-image" src="" alt="Person">
            <div class="next-arrow" id="next-arrow">‚û°Ô∏è</div>
        </div>
        <div class="questions" id="questions">
            <div id="alive-question">
                <label><input type="radio" name="alive" value="alive"> Alive</label>
                <label><input type="radio" name="alive" value="dead"> Dead</label>
            </div>
            <div id="gender-question" style="display: none;">
                <label><input type="radio" name="gender" value="male"> Male</label>
                <label><input type="radio" name="gender" value="female"> Female</label>
            </div>
        </div>
        <button class="check-button" id="check-button">Check</button>
        <div class="result" id="result"></div>
        <div class="statistics" id="statistics">
            Correct: <span id="correct-count">0</span> | Incorrect: <span id="incorrect-count">0</span>
        </div>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        // Telegram Web Apps integration
        const tg = window.Telegram.WebApp;
        tg.expand();
        document.getElementById('player-name').textContent = tg.initDataUnsafe.user?.first_name || 'Player';

        // Language translations
        const translations = {
            uk: {
                alive: '–ñ–∏–≤–∏–π', dead: '–ú–µ—Ä—Ç–≤–∏–π', male: '–ß–æ–ª–æ–≤—ñ–∫', female: '–ñ—ñ–Ω–∫–∞',
                check: '–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏', simple: '–ü—Ä–æ—Å—Ç–∏–π', verySimple: '–î—É–∂–µ –ø—Ä–æ—Å—Ç–∏–π',
                correct: '–ü—Ä–∞–≤–∏–ª—å–Ω–æ', incorrect: '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ'
            },
            ru: {
                alive: '–ñ–∏–≤', dead: '–ú—ë—Ä—Ç–≤', male: '–ú—É–∂—á–∏–Ω–∞', female: '–ñ–µ–Ω—â–∏–Ω–∞',
                check: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å', simple: '–ü—Ä–æ—Å—Ç–æ–π', verySimple: '–û—á–µ–Ω—å –ø—Ä–æ—Å—Ç–æ–π',
                correct: '–ü—Ä–∞–≤–∏–ª—å–Ω–æ', incorrect: '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ'
            },
            en: {
                alive: 'Alive', dead: 'Dead', male: 'Male', female: 'Female',
                check: 'Check', simple: 'Simple', verySimple: 'Very Simple',
                correct: 'Correct', incorrect: 'Incorrect'
            },
            alien: {
                alive: 'üëΩ', dead: 'üíÄ', male: 'üöπ', female: 'üö∫',
                check: 'üîç', simple: 'ü™ê', verySimple: 'üåå',
                correct: '‚úÖ', incorrect: '‚ùå'
            }
        };

        // State
        let currentPerson = null;
        let correctAnswers = 0;
        let incorrectAnswers = 0;
        let difficulty = 'very-simple';
        let language = 'en';
        let isChecking = false;

        // Elements
        const display = document.getElementById('display');
        const personImage = document.getElementById('person-image');
        const loading = document.getElementById('loading');
        const nextArrow = document.getElementById('next-arrow');
        const questions = document.getElementById('questions');
        const aliveQuestion = document.getElementById('alive-question');
        const genderQuestion = document.getElementById('gender-question');
        const checkButton = document.getElementById('check-button');
        const result = document.getElementById('result');
        const correctCount = document.getElementById('correct-count');
        const incorrectCount = document.getElementById('incorrect-count');
        const languageSelect = document.getElementById('language');
        const difficultySelect = document.getElementById('difficulty');
        const themeToggle = document.getElementById('theme-toggle');

        // Theme toggle
        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('light');
            themeToggle.textContent = document.body.classList.contains('light') ? '‚òÄÔ∏è Day' : 'üåô Night';
        });

        // Language and difficulty change
        languageSelect.addEventListener('change', () => {
            language = languageSelect.value;
            updateUI();
        });

        difficultySelect.addEventListener('change', () => {
            difficulty = difficultySelect.value;
            updateUI();
            fetchNewPerson();
        });

        // Update UI based on language and difficulty
        function updateUI() {
            const t = translations[language];
            aliveQuestion.innerHTML = `
                <label><input type="radio" name="alive" value="alive"> ${t.alive}</label>
                <label><input type="radio" name="alive" value="dead"> ${t.dead}</label>
            `;
            genderQuestion.innerHTML = `
                <label><input type="radio" name="gender" value="male"> ${t.male}</label>
                <label><input type="radio" name="gender" value="female"> ${t.female}</label>
            `;
            checkButton.textContent = t.check;
            difficultySelect.options[0].textContent = t.simple;
            difficultySelect.options[1].textContent = t.verySimple;
            genderQuestion.style.display = difficulty === 'simple' ? 'block' : 'none';
            personImage.style.display = difficulty === 'very-simple' && currentPerson ? 'block' : 'none';
        }

        // Fetch random person from Wikipedia API
        async function fetchNewPerson() {
            if (isChecking) return;
            isChecking = true;
            loading.style.display = 'block';
            personImage.style.display = 'none';
            result.style.display = 'none';
            checkButton.style.display = 'block';
            questions.style.display = 'block';
            resetRadioButtons();

            try {
                loading.textContent = 'Loading: 10%';
                // Get random article
                let response = await fetch('https://en.wikipedia.org/w/api.php?' +
                    'action=query&list=random&rnnamespace=0&rnlimit=1&format=json&origin=*');
                let data = await response.json();
                let randomTitle = data.query.random[0].title;

                // Ensure it's a person (category check)
                loading.textContent = 'Loading: 30%';
                response = await fetch(`https://en.wikipedia.org/w/api.php?action=query&titles=${encodeURIComponent(randomTitle)}&prop=categories&cllimit=10&format=json&origin=*`);
                data = await response.json();
                const page = Object.values(data.query.pages)[0];
                if (!page.categories || !page.categories.some(cat => cat.title.includes('Living people') || cat.title.includes('people'))) {
                    console.log('Not a person, retrying...');
                    isChecking = false;
                    return fetchNewPerson();
                }

                // Get person details
                loading.textContent = 'Loading: 50%';
                response = await fetch(`https://en.wikipedia.org/w/api.php?action=query&titles=${encodeURIComponent(randomTitle)}&prop=extracts|pageimages&exintro&explaintext&pithumbsize=500&format=json&origin=*`);
                data = await response.json();
                const personPage = Object.values(data.query.pages)[0];
                const extract = personPage.extract || '';

                // Determine if alive or dead
                const isAlive = extract.includes('born') && !extract.includes('died');
                const gender = extract.includes('she ') || extract.includes('her ') ? 'female' : 'male';

                // Get image
                loading.textContent = 'Loading: 70%';
                let imageUrl = personPage.thumbnail?.source || null;
                if (imageUrl && !await isValidImage(imageUrl)) {
                    console.log('Invalid image, retrying...');
                    isChecking = false;
                    return fetchNewPerson();
                }

                currentPerson = {
                    name: randomTitle,
                    isAlive: isAlive ? 'alive' : 'dead',
                    gender,
                    imageUrl,
                    wikiUrl: `https://en.wikipedia.org/wiki/${encodeURIComponent(randomTitle)}`
                };

                loading.textContent = 'Loading: 100%';
                setTimeout(() => {
                    loading.style.display = 'none';
                    if (difficulty === 'very-simple' && currentPerson.imageUrl) {
                        personImage.src = currentPerson.imageUrl;
                        personImage.style.display = 'block';
                    }
                    isChecking = false;
                }, 500);

                console.log('Person loaded:', currentPerson);
            } catch (error)37 {
                console.error('Error fetching person:', error);
                loading.textContent = 'Error, retrying...';
                isChecking = false;
                setTimeout(fetchNewPerson, 1000);
            }
        }

        // Validate image
        async function isValidImage(url) {
            try {
                const response = await fetch(url, { method: 'HEAD' });
                if (!response.ok) return false;
                const contentType = response.headers.get('content-type');
                return contentType.startsWith('image/');
            } catch {
                return false;
            }
        }

        // Reset radio buttons
        function resetRadioButtons() {
            document.querySelectorAll('input[type="radio"]').forEach(input => {
                input.checked = false;
                input.parentElement.classList.remove('correct', 'incorrect');
            });
        }

        // Check answers
        checkButton.addEventListener('click', () => {
            if (!currentPerson || isChecking) return;
            const aliveAnswer = document.querySelector('input[name="alive"]:checked')?.value;
            let genderAnswer = document.querySelector('input[name="gender"]:checked')?.value;

            if (!aliveAnswer || (difficulty === 'simple' && !genderAnswer)) {
                alert('Please select all answers.');
                return;
            }

            let correct = true;
            const t = translations[language];

            // Check alive/dead
            if (aliveAnswer === currentPerson.isAlive) {
                document.querySelector(`input[name="alive"][value="${aliveAnswer}"]`).parentElement.classList.add('correct');
            } else {
                document.querySelector(`input[name="alive"][value="${aliveAnswer}"]`).parentElement.classList.add('incorrect');
                correct = false;
            }

            // Check gender (if simple mode)
            if (difficulty === 'simple') {
                if (genderAnswer === currentPerson.gender) {
                    document.querySelector(`input[name="gender"][value="${genderAnswer}"]`).parentElement.classList.add('correct');
                } else {
                    v√≠document.querySelector(`input[name="gender"][value="${genderAnswer}"]`).parentElement.classList.add('incorrect');
                    correct = false;
                }
            }

            // Update statistics
            if (correct) {
                correctAnswers++;
                gtag('event', 'answer_correct', { mode: difficulty, language });
            } else {
                incorrectAnswers++;
                gtag('event', 'answer_incorrect', { mode: difficulty, language });
            }
            correctCount.textContent = correctAnswers;
            incorrectCount.textContent = incorrectAnswers;

            // Show result
            personImage.src = currentPerson.imageUrl || '';
            personImage.style.display = currentPerson.imageUrl ? 'block' : 'none';
            result.innerHTML = `
                <p>${currentPerson.name}</p>
                <a href="${currentPerson.wikiUrl}" target="_blank">Wikipedia</a>
            `;
            result.style.display = 'block';
            checkButton.style.display = 'none';
            questions.style.display = 'none';

            isChecking = false;
        });

        // Next person
        nextArrow.addEventListener('click', () => {
            if (isChecking) return;
            fetchNewPerson();
        });

        // Initial setup
        updateUI();
        fetchNewPerson();

        // Log for debugging
        console.log('Game initialized');
    </script>
</body>
</html>
