<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Who Is It? - Telegram Mini App</title>
    <style>
        body {
            background: #1C2526;
            color: #E0E0E0;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            touch-action: manipulation;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .photo-frame {
            position: relative;
            width: 100%;
            aspect-ratio: 1;
            background: #2C3539;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .photo-frame img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }

        .photo-frame.closed img {
            display: none;
        }

        .photo-frame.open img {
            display: block;
        }

        .progress-bar {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.7);
        }

        .progress-text {
            font-size: 24px;
            color: #E0E0E0;
        }

        .question-section {
            margin-bottom: 20px;
        }

        .radio-group {
            margin: 15px 0;
        }

        .radio-group label {
            margin-right: 20px;
            font-size: 16px;
        }

        .radio-group input {
            margin-right: 5px;
        }

        .control-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: #3A4F50;
            color: #E0E0E0;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.2s;
        }

        button:hover {
            background: #4A6061;
        }

        .result {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background: #2C3539;
            border-radius: 8px;
        }

        .result.correct {
            background: #2E7D32;
        }

        .result.incorrect {
            background: #C62828;
        }

        .stats {
            margin-top: auto;
            padding: 15px;
            background: #2C3539;
            border-radius: 8px;
            font-size: 14px;
        }

        .bottom-controls {
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
        }

        .light-theme {
            background: #E0E0E0;
            color: #1C2526;
        }

        .light-theme .photo-frame,
        .light-theme .stats,
        .light-theme .result {
            background: #CFD8DC;
        }

        .light-theme button {
            background: #78909C;
            color: #1C2526;
        }

        .light-theme button:hover {
            background: #90A4AE;
        }

        select {
            padding: 8px;
            border-radius: 8px;
            background: #3A4F50;
            color: #E0E0E0;
            border: none;
        }
    </style>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-TQ5F8JW26S"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-TQ5F8JW26S');
    </script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <select id="language">
                <option value="en">English</option>
                <option value="uk">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</option>
                <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                <option value="alien">üëΩ Alien</option>
            </select>
            <select id="difficulty">
                <option value="open">Open</option>
                <option value="closed">Closed</option>
            </select>
            <button id="theme-toggle">üåô</button>
        </div>

        <div class="photo-frame" id="photo-frame">
            <img id="person-image" src="" alt="Person">
            <div class="progress-bar" id="progress-bar">
                <span class="progress-text" id="progress-text">0%</span>
            </div>
        </div>

        <div class="question-section">
            <div class="radio-group">
                <label><input type="radio" name="status" value="alive"> Alive</label>
                <label><input type="radio" name="status" value="dead"> Dead</label>
            </div>
            <div class="radio-group">
                <label><input type="radio" name="gender" value="male"> Male</label>
                <label><input type="radio" name="gender" value="female"> Female</label>
            </div>
        </div>

        <div class="control-buttons">
            <button id="check-button">Check</button>
        </div>

        <div class="result" id="result">
            <p id="result-text"></p>
            <a id="wiki-link" href="#" target="_blank"></a>
        </div>

        <div class="stats" id="stats">
            Correct: <span id="correct-count">0</span> | Incorrect: <span id="incorrect-count">0</span> | Total: <span id="total-count">0</span>
        </div>

        <div class="bottom-controls">
            <button id="exit-button">Exit</button>
            <button id="next-button">Next</button>
        </div>
    </div>

    <script>
        const translations = {
            en: {
                alive: 'Alive',
                dead: 'Dead',
                male: 'Male',
                female: 'Female',
                check: 'Check',
                exit: 'Exit',
                next: 'Next',
                correct: 'Correct! This is {name}.',
                incorrect: 'Incorrect. This is {name}.',
            },
            uk: {
                alive: '–ñ–∏–≤–∏–π',
                dead: '–ú–µ—Ä—Ç–≤–∏–π',
                male: '–ß–æ–ª–æ–≤—ñ–∫',
                female: '–ñ—ñ–Ω–∫–∞',
                check: '–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏',
                exit: '–í–∏—Ö—ñ–¥',
                next: '–ù–∞—Å—Ç—É–ø–Ω–µ',
                correct: '–ü—Ä–∞–≤–∏–ª—å–Ω–æ! –¶–µ {name}.',
                incorrect: '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ. –¶–µ {name}.',
            },
            ru: {
                alive: '–ñ–∏–≤–æ–π',
                dead: '–ú–µ—Ä—Ç–≤—ã–π',
                male: '–ú—É–∂—á–∏–Ω–∞',
                female: '–ñ–µ–Ω—â–∏–Ω–∞',
                check: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å',
                exit: '–í—ã—Ö–æ–¥',
                next: '–°–ª–µ–¥—É—é—â–µ–µ',
                correct: '–ü—Ä–∞–≤–∏–ª—å–Ω–æ! –≠—Ç–æ {name}.',
                incorrect: '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ. –≠—Ç–æ {name}.',
            },
            alien: {
                alive: 'üëΩ',
                dead: 'üíÄ',
                male: '‚ôÇÔ∏è',
                female: '‚ôÄÔ∏è',
                check: 'üîç',
                exit: 'üö™',
                next: '‚û°Ô∏è',
                correct: '‚úÖ –≠—Ç–æ {name}.',
                incorrect: '‚ùå –≠—Ç–æ {name}.',
            }
        };

        let currentLang = 'en';
        let difficulty = 'open';
        let isLightTheme = false;
        let correctCount = 0;
        let incorrectCount = 0;
        let currentPerson = null;

        const elements = {
            language: document.getElementById('language'),
            difficulty: document.getElementById('difficulty'),
            themeToggle: document.getElementById('theme-toggle'),
            photoFrame: document.getElementById('photo-frame'),
            personImage: document.getElementById('person-image'),
            progressBar: document.getElementById('progress-bar'),
            progressText: document.getElementById('progress-text'),
            checkButton: document.getElementById('check-button'),
            exitButton: document.getElementById('exit-button'),
            nextButton: document.getElementById('next-button'),
            result: document.getElementById('result'),
            resultText: document.getElementById('result-text'),
            wikiLink: document.getElementById('wiki-link'),
            stats: {
                correct: document.getElementById('correct-count'),
                incorrect: document.getElementById('incorrect-count'),
                total: document.getElementById('total-count'),
            }
        };

        // Telegram Web App initialization
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // Initialize player name
        const playerName = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.first_name : 'Player';
        console.log(`Player: ${playerName}`);

        // Theme toggle
        elements.themeToggle.addEventListener('click', () => {
            isLightTheme = !isLightTheme;
            document.body.classList.toggle('light-theme', isLightTheme);
            elements.themeToggle.textContent = isLightTheme ? '‚òÄÔ∏è' : 'üåô';
            gtag('event', 'theme_change', { theme: isLightTheme ? 'light' : 'dark' });
        });

        // Language change
        elements.language.addEventListener('change', (e) => {
            currentLang = e.target.value;
            updateUIText();
            gtag('event', 'language_change', { language: currentLang });
        });

        // Difficulty change
        elements.difficulty.addEventListener('change', (e) => {
            difficulty = e.target.value;
            elements.photoFrame.classList.toggle('closed', difficulty === 'closed');
            elements.photoFrame.classList.toggle('open', difficulty === 'open');
            loadNewPerson();
            gtag('event', 'difficulty_change', { difficulty });
        });

        // UI text update
        function updateUIText() {
            const t = translations[currentLang];
            document.querySelectorAll('label').forEach((label, i) => {
                if (i === 0) label.textContent = t.alive;
                else if (i === 1) label.textContent = t.dead;
                else if (i === 2) label.textContent = t.male;
                else if (i === 3) label.textContent = t.female;
            });
            elements.checkButton.textContent = t.check;
            elements.exitButton.textContent = t.exit;
            elements.nextButton.textContent = t.next;
        }

        // Wikipedia API handling
        async function fetchRandomPerson() {
            try {
                const response = await fetch('https://en.wikipedia.org/w/api.php?' + new URLSearchParams({
                    action: 'query',
                    format: 'json',
                    list: 'random',
                    rnnamespace: 0,
                    rnlimit: 1,
                    origin: '*'
                }));

                const data = await response.json();
                const page = data.query.random[0];
                return await getPersonDetails(page.title);
            } catch (error) {
                console.error('Error fetching random person:', error);
                return null;
            }
        }

        async function getPersonDetails(title) {
            try {
                const response = await fetch('https://en.wikipedia.org/w/api.php?' + new URLSearchParams({
                    action: 'query',
                    format: 'json',
                    titles: title,
                    prop: 'pageimages|info|extracts',
                    pithumbsize: 500,
                    inprop: 'url',
                    exintro: true,
                    explaintext: true,
                    origin: '*'
                }));

                const data = await response.json();
                const page = Object.values(data.query.pages)[0];
                
                // Validate image
                if (!page.thumbnail || !page.thumbnail.source) {
                    return null;
                }

                // Basic check for human face (simplified)
                const extract = page.extract || '';
                if (!extract.toLowerCase().includes('born') && !extract.toLowerCase().includes('human')) {
                    return null;
                }

                // Simulate gender and status (Wikipedia doesn't provide this directly)
                const isAlive = Math.random() > 0.3; // Simplified
                const gender = Math.random() > 0.5 ? 'male' : 'female'; // Simplified

                return {
                    name: page.title,
                    image: page.thumbnail.source,
                    wikiUrl: page.fullurl,
                    isAlive,
                    gender
                };
            } catch (error) {
                console.error('Error fetching person details:', error);
                return null;
            }
        }

        // Load new person with progress
        async function loadNewPerson() {
            elements.result.style.display = 'none';
            elements.progressBar.style.display = 'flex';
            elements.progressText.textContent = '0%';
            elements.photoFrame.classList.add(difficulty === 'closed' ? 'closed' : 'open');

            let person = null;
            let attempts = 0;
            const maxAttempts = 5;

            while (!person && attempts < maxAttempts) {
                person = await fetchRandomPerson();
                attempts++;
                elements.progressText.textContent = `${Math.round((attempts / maxAttempts) * 100)}%`;
            }

            if (!person) {
                console.error('Failed to load person after max attempts');
                elements.progressText.textContent = 'Error';
                return;
            }

            currentPerson = person;
            elements.personImage.src = person.image;
            elements.progressBar.style.display = 'none';
            resetInputs();
            console.log('Loaded person:', person.name);
            gtag('event', 'person_loaded', { person: person.name });
        }

        // Reset radio inputs
        function resetInputs() {
            document.querySelectorAll('input[type="radio"]').forEach(input => input.checked = false);
        }

        // Check answers
        elements.checkButton.addEventListener('click', () => {
            if (!currentPerson) return;

            const statusInput = document.querySelector('input[name="status"]:checked');
            const genderInput = document.querySelector('input[name="gender"]:checked');

            if (!statusInput || !genderInput) {
                alert('Please select both status and gender');
                return;
            }

            const isStatusCorrect = statusInput.value === (currentPerson.isAlive ? 'alive' : 'dead');
            const isGenderCorrect = genderInput.value === currentPerson.gender;

            const isCorrect = isStatusCorrect && isGenderCorrect;
            correctCount += isCorrect ? 1 : 0;
            incorrectCount += isCorrect ? 0 : 1;

            elements.result.style.display = 'block';
            elements.result.classList.toggle('correct', isCorrect);
            elements.result.classList.toggle('incorrect', !isCorrect);
            elements.photoFrame.classList.remove('closed');
            elements.photoFrame.classList.add('open');

            const t = translations[currentLang];
            elements.resultText.textContent = (isCorrect ? t.correct : t.incorrect).replace('{name}', currentPerson.name);
            elements.wikiLink.href = currentPerson.wikiUrl;
            elements.wikiLink.textContent = `Wikipedia: ${currentPerson.name}`;

            updateStats();
            gtag('event', 'answer_submitted', {
                person: currentPerson.name,
                is_correct: isCorrect,
                status_correct: isStatusCorrect,
                gender_correct: isGenderCorrect
            });
        });

        // Update stats
        function updateStats() {
            elements.stats.correct.textContent = correctCount;
            elements.stats.incorrect.textContent = incorrectCount;
            elements.stats.total.textContent = correctCount + incorrectCount;
        }

        // Next person
        elements.nextButton.addEventListener('click', () => {
            loadNewPerson();
        });

        // Exit
        elements.exitButton.addEventListener('click', () => {
            tg.close();
        });

        // Initial load
        updateUIText();
        loadNewPerson();
    </script>
</body>
</html>
