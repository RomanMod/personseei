<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guess Who - Telegram Mini App</title>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-TQ5F8JW26S"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-TQ5F8JW26S');
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #1c2526; /* Space Gray - Night */
            color: #ffffff;
            transition: background-color 0.3s, color 0.3s;
        }
        body.day {
            background-color: #f0f0f0; /* Day */
            color: #000000;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            text-align: center;
        }
        #display {
            width: 100%;
            height: 300px;
            background-color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }
        #display img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        #display.hidden {
            background-color: #000;
            color: #fff;
            font-size: 24px;
        }
        #next-arrow {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 30px;
            cursor: pointer;
            color: #00ccff;
        }
        .button, .theme-toggle, .lang-select, .mode-select {
            background-color: #3a3f44; /* Space Gray button */
            color: #ffffff;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        body.day .button, body.day .theme-toggle, body.day .lang-select, body.day .mode-select {
            background-color: #d0d0d0; /* Day button */
            color: #000000;
        }
        .button:hover, .theme-toggle:hover, .lang-select:hover, .mode-select:hover {
            background-color: #00ccff;
        }
        .radio-group {
            margin: 20px 0;
        }
        .radio-group label {
            margin: 0 10px;
        }
        .correct {
            color: #00ff00 !important;
        }
        .incorrect {
            color: #ff0000 !important;
        }
        #result {
            margin-top: 20px;
        }
        #stats {
            margin-top: 20px;
            font-size: 14px;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: #fff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="player-name">Player</h1>
        <button class="theme-toggle" onclick="toggleTheme()">Night Mode</button><br>
        <select class="lang-select" onchange="changeLanguage(this.value)">
            <option value="en">English</option>
            <option value="uk">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</option>
            <option value="ru">–†—É—Å—Å–∫–∏–π</option>
            <option value="alien">üëΩ Alien</option>
        </select><br>
        <select class="mode-select" onchange="changeMode(this.value)">
            <option value="very-simple">Very Simple</option>
            <option value="simple">Simple</option>
        </select>
        <div id="display">
            <div id="loading">Loading: 0%</div>
            <div id="next-arrow" onclick="loadNewPerson()">‚û°Ô∏è</div>
        </div>
        <div class="radio-group" id="alive-group">
            <label><input type="radio" name="alive" value="alive"> Alive</label>
            <label><input type="radio" name="alive" value="dead"> Dead</label>
        </div>
        <div class="radio-group" id="gender-group">
            <label><input type="radio" name="gender" value="male"> Male</label>
            <label><input type="radio" name="gender" value="female"> Female</label>
        </div>
        <button class="button" onclick="checkAnswers()">Check</button>
        <div id="result"></div>
        <div id="stats">Games Played: 0 | Correct Answers: 0</div>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        // Telegram Web Apps API Integration
        const tg = window.Telegram.WebApp;
        tg.ready();
        document.getElementById('player-name').textContent = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.first_name : 'Player';

        // Game State
        let currentPerson = null;
        let gamesPlayed = 0;
        let correctAnswers = 0;
        let mode = 'very-simple'; // Default mode
        let language = 'en'; // Default language
        let isNightMode = true; // Default night mode

        // Language Translations
        const translations = {
            en: {
                alive: 'Alive', dead: 'Dead', male: 'Male', female: 'Female', check: 'Check',
                correct: 'Correct!', incorrect: 'Incorrect!', stats: 'Games Played: {games} | Correct Answers: {correct}',
                loading: 'Loading: {percent}%', error: 'Error loading image. Trying another...'
            },
            uk: {
                alive: '–ñ–∏–≤–∏–π', dead: '–ú–µ—Ä—Ç–≤–∏–π', male: '–ß–æ–ª–æ–≤—ñ–∫', female: '–ñ—ñ–Ω–∫–∞', check: '–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏',
                correct: '–ü—Ä–∞–≤–∏–ª—å–Ω–æ!', incorrect: '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ!', stats: '–Ü–≥–æ—Ä –∑—ñ–≥—Ä–∞–Ω–æ: {games} | –ü—Ä–∞–≤–∏–ª—å–Ω–∏—Ö –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π: {correct}',
                loading: '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: {percent}%', error: '–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è. –°–ø—Ä–æ–±—É—î–º–æ —ñ–Ω—à–µ...'
            },
            ru: {
                alive: '–ñ–∏–≤', dead: '–ú—ë—Ä—Ç–≤', male: '–ú—É–∂—á–∏–Ω–∞', female: '–ñ–µ–Ω—â–∏–Ω–∞', check: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å',
                correct: '–ü—Ä–∞–≤–∏–ª—å–Ω–æ!', incorrect: '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ!', stats: '–ò–≥—Ä —Å—ã–≥—Ä–∞–Ω–æ: {games} | –ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: {correct}',
                loading: '–ó–∞–≥—Ä—É–∑–∫–∞: {percent}%', error: '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è. –ü—Ä–æ–±—É–µ–º –¥—Ä—É–≥–æ–µ...'
            },
            alien: {
                alive: 'üëΩ', dead: 'üíÄ', male: '‚ôÇ', female: '‚ôÄ', check: 'üîç',
                correct: '‚úÖ', incorrect: '‚ùå', stats: 'üéÆ: {games} | ‚úÖ: {correct}',
                loading: 'üõ∏: {percent}%', error: 'üö´ üñºÔ∏è. üåå...'
            }
        };

        // Theme Toggle
        function toggleTheme() {
            isNightMode = !isNightMode;
            document.body.classList.toggle('day', !isNightMode);
            document.querySelector('.theme-toggle').textContent = isNightMode ? 'Night Mode' : 'Day Mode';
        }

        // Language Change
        function changeLanguage(lang) {
            language = lang;
            updateUI();
        }

        // Mode Change
        function changeMode(newMode) {
            mode = newMode;
            document.getElementById('gender-group').style.display = mode === 'simple' ? 'block' : 'none';
            document.getElementById('display').classList.toggle('hidden', mode === 'simple' && !currentPerson?.checked);
            updateUI();
        }

        // Update UI with translations
        function updateUI() {
            const t = translations[language];
            document.querySelectorAll('#alive-group label')[0].textContent = t.alive;
            document.querySelectorAll('#alive-group label')[1].textContent = t.dead;
            if (mode === 'simple') {
                document.querySelectorAll('#gender-group label')[0].textContent = t.male;
                document.querySelectorAll('#gender-group label')[1].textContent = t.female;
            }
            document.querySelector('.button').textContent = t.check;
            document.getElementById('stats').textContent = t.stats.replace('{games}', gamesPlayed).replace('{correct}', correctAnswers);
            if (!currentPerson?.image) {
                document.getElementById('loading').textContent = t.loading.replace('{percent}', currentPerson?.loadingPercent || 0);
            }
        }

        // Load New Person
        async function loadNewPerson() {
            log('Loading new person...');
            currentPerson = { loadingPercent: 0, checked: false };
            updateUI();
            document.getElementById('display').classList.add('hidden', mode === 'simple');
            document.getElementById('display').innerHTML = `<div id="loading">${translations[language].loading.replace('{percent}', '0')}</div><div id="next-arrow" onclick="loadNewPerson()">‚û°Ô∏è</div>`;
            document.getElementById('result').innerHTML = '';
            resetRadios();

            try {
                // Fetch random Wikipedia article
                let query = mode === 'simple' ? 'Category:Notable_people' : 'Category:People';
                let response = await fetch(`https://${language}.wikipedia.org/w/api.php?action=query&list=random&rnnamespace=0&rnlimit=1&origin=*`);
                currentPerson.loadingPercent = 20;
                updateUI();

                let data = await response.json();
                let title = data.query.random[0].title;

                // Fetch article details
                response = await fetch(`https://${language}.wikipedia.org/w/api.php?action=query&prop=pageimages|extracts&titles=${encodeURIComponent(title)}&pithumbsize=500&exintro&explaintext&origin=*`);
                currentPerson.loadingPercent = 40;
                updateUI();

                data = await response.json();
                let page = Object.values(data.query.pages)[0];
                let imageUrl = page.thumbnail?.source;
                currentPerson.name = page.title;
                currentPerson.extract = page.extract;

                // Parse extract for alive/dead and gender (simplified)
                currentPerson.isAlive = !page.extract.includes('died') && !page.extract.includes('—Å–º–µ—Ä—Ç—å') && !page.extract.includes('–ø–æ–º–µ—Ä');
                currentPerson.gender = page.extract.includes('she') || page.extract.includes('her') || page.extract.includes('–≤–æ–Ω–∞') || page.extract.includes('—ó—ó') ? 'female' : 'male';

                // Fetch Wikipedia page URL
                response = await fetch(`https://${language}.wikipedia.org/w/api.php?action=query&titles=${encodeURIComponent(title)}&prop=info&inprop=url&origin=*`);
                data = await response.json();
                currentPerson.wikiUrl = Object.values(data.query.pages)[0].fullurl;
                currentPerson.loadingPercent = 60;
                updateUI();

                // Validate image
                if (!imageUrl) throw new Error('No image found');
                let img = new Image();
                img.src = imageUrl;
                await new Promise((resolve, reject) => {
                    img.onload = () => {
                        // Basic validation: check if image is too small or likely not a face
                        if (img.width < 100 || img.height < 100) {
                            reject(new Error('Image too small'));
                        } else {
                            resolve();
                        }
                    };
                    img.onerror = () => reject(new Error('Image load error'));
                });

                currentPerson.image = imageUrl;
                currentPerson.loadingPercent = 100;
                document.getElementById('display').innerHTML = `<img src="${imageUrl}" alt="${currentPerson.name}"><div id="next-arrow" onclick="loadNewPerson()">‚û°Ô∏è</div>`;
                document.getElementById('display').classList.remove('hidden', mode === 'very-simple');
                log('Person loaded:', currentPerson);
            } catch (error) {
                log('Error:', error.message);
                document.getElementById('loading').textContent = translations[language].error;
                setTimeout(loadNewPerson, 2000); // Retry after delay
            }
        }

        // Reset Radio Buttons
        function resetRadios() {
            document.querySelectorAll('input[type="radio"]').forEach(radio => radio.checked = false);
            document.querySelectorAll('label').forEach(label => label.classList.remove('correct', 'incorrect'));
        }

        // Check Answers
        function checkAnswers() {
            if (!currentPerson?.image) return;
            if (currentPerson.checked) return;

            let aliveAnswer = document.querySelector('input[name="alive"]:checked')?.value;
            let genderAnswer = document.querySelector('input[name="gender"]:checked')?.value;
            let correct = 0;

            // Check alive/dead
            let isAliveCorrect = aliveAnswer === (currentPerson.isAlive ? 'alive' : 'dead');
            if (isAliveCorrect) correct++;
            document.querySelector(`input[name="alive"][value="${currentPerson.isAlive ? 'alive' : 'dead'}"]`).parentElement.classList.add('correct');
            if (aliveAnswer && !isAliveCorrect) {
                document.querySelector(`input[name="alive"][value="${aliveAnswer}"]`).parentElement.classList.add('incorrect');
            }

            // Check gender (only in simple mode)
            let isGenderCorrect = true;
            if (mode === 'simple') {
                isGenderCorrect = genderAnswer === currentPerson.gender;
                if (isGenderCorrect) correct++;
                document.querySelector(`input[name="gender"][value="${currentPerson.gender}"]`).parentElement.classList.add('correct');
                if (genderAnswer && !isGenderCorrect) {
                    document.querySelector(`input[name="gender"][value="${genderAnswer}"]`).parentElement.classList.add('incorrect');
                }
            }

            // Show result
            currentPerson.checked = true;
            document.getElementById('display').classList.remove('hidden');
            if (!document.getElementById('display').querySelector('img')) {
                document.getElementById('display').innerHTML = `<img src="${currentPerson.image}" alt="${currentPerson.name}"><div id="next-arrow" onclick="loadNewPerson()">‚û°Ô∏è</div>`;
            }
            document.getElementById('result').innerHTML = `
                <p>${currentPerson.name}</p>
                <a href="${currentPerson.wikiUrl}" target="_blank">Wikipedia</a>
                <p>${isAliveCorrect && isGenderCorrect ? translations[language].correct : translations[language].incorrect}</p>
            `;

            // Update stats
            gamesPlayed++;
            correctAnswers += correct;
            updateUI();

            // Log to GA4
            gtag('event', 'game_played', {
                mode: mode,
                language: language,
                correct_answers: correct,
                person: currentPerson.name
            });

            log('Answers checked:', { aliveAnswer, genderAnswer, isAliveCorrect, isGenderCorrect, correct });
        }

        // Logging
        function log(...args) {
            console.log('[Game]', ...args);
        }

        // Initialize
        document.getElementById('gender-group').style.display = 'none'; // Default very-simple mode
        loadNewPerson();
    </script>
</body>
</html>
