<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>–í–∏–ø–∞–¥–∫–æ–≤–µ —Ñ–æ—Ç–æ –ª—é–¥–∏–Ω–∏ –∑ Wikidata</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f9f9f9;
            text-align: center;
            padding: 40px;
        }

        h1 {
            color: #333;
        }

        #person-image {
            display: block;
            max-width: 100%;
            max-height: 300px;
            width: auto;
            height: auto;
            border: 2px solid #999;
            border-radius: 10px;
            margin: 0 auto;
            opacity: 0;
            transition: opacity 0.5s ease-in;
        }

        #person-image.loaded {
            opacity: 1;
        }

        #person-name {
            margin-top: 15px;
            font-size: 1.5em;
            font-weight: bold;
        }

        #progress {
            margin-top: 20px;
            font-style: italic;
            color: #888;
        }

        #progress.error {
            color: red;
        }

        .btn-container {
            margin-top: 20px;
        }

        .btn-container button {
            margin: 5px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }

        .time-info {
            margin-top: 5px;
            font-size: 0.9em;
            color: #666;
        }

        .stats {
            margin-top: 20px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
            display: inline-block;
        }
    </style>
</head>
<body>

    <h1>–í–∏–ø–∞–¥–∫–æ–≤–∞ –ª—é–¥–∏–Ω–∞ –∑ Wikidata</h1>
    <img id="person-image" src="" alt="–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ª—é–¥–∏–Ω–∏">
    <div id="person-name"></div>
    <div id="progress">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>

    <div class="btn-container">
        <button onclick="loadPerson(true)">
            üéØ –°—É–ø–µ—Ä –≤–∏–ø–∞–¥–∫–æ–≤–æ (–ø–æ–≤—ñ–ª—å–Ω–æ)
        </button>
        <div id="time-slow" class="time-info"></div>
        
        <button onclick="loadPerson(false)">
            ‚ö° –®–≤–∏–¥–∫–æ (–∑–±–∞–ª–∞–Ω—Å–æ–≤–∞–Ω–∞ –≤–∏–ø–∞–¥–∫–æ–≤—ñ—Å—Ç—å)
        </button>
        <div id="time-fast" class="time-info"></div>
    </div>

    <div class="stats">
        <div>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è:</div>
        <div id="stats-slow">–ü–æ–≤—ñ–ª—å–Ω–∏–π —Ä–µ–∂–∏–º: -</div>
        <div id="stats-fast">–®–≤–∏–¥–∫–∏–π —Ä–µ–∂–∏–º: -</div>
    </div>

    <script>
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        const settings = {
            superRandomPeople: false, // ORDER BY RAND(), –≤—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ Wikidata
            RandomPeople: true, // SAMPLE() –∏–ª–∏ OFFSET –¥–ª—è –±–∞–ª–∞–Ω—Å–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏ —Å–ª—É—á–∞–π–Ω–æ—Å—Ç–∏
            dynamicOffset: true, // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –¥–∏–∞–ø–∞–∑–æ–Ω —Å OFFSET
            maxOffset: 100, // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Å–¥–≤–∏–≥ –¥–ª—è OFFSET
            maxPeople: 100, // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª—é–¥–µ–π –≤ –æ–¥–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ
            sessionPeople: 10, // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª—é–¥–µ–π –∑–∞ –æ–¥–Ω—É —Å–µ—Å—Å–∏—é
            genderRatio: { male: 50, female: 50 }, // 50/50 –º—É–∂—á–∏–Ω –∏ –∂–µ–Ω—â–∏–Ω
            statusRatio: { alive: 50, deceased: 50 } // 50/50 –∂–∏–≤—ã—Ö –∏ –º—ë—Ä—Ç–≤—ã—Ö
        };

        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        const stats = {
            slow: { count: 0, totalTime: 0, lastTime: 0 },
            fast: { count: 0, totalTime: 0, lastTime: 0 }
        };

        function updateStats(mode, time) {
            stats[mode].count++;
            stats[mode].totalTime += time;
            stats[mode].lastTime = time;
            
            const avgTime = stats[mode].totalTime / stats[mode].count;
            document.getElementById(`stats-${mode}`).textContent = 
                `${mode === 'slow' ? '–ü–æ–≤—ñ–ª—å–Ω–∏–π' : '–®–≤–∏–¥–∫–∏–π'} —Ä–µ–∂–∏–º: ` +
                `–û—Å—Ç–∞–Ω–Ω—î: ${time.toFixed(0)}–º—Å, ` +
                `–°–µ—Ä–µ–¥–Ω—î: ${avgTime.toFixed(0)}–º—Å, ` +
                `–ó–∞–ø–∏—Ç—ñ–≤: ${stats[mode].count}`;
                
            document.getElementById(`time-${mode}`).textContent = 
                `–ß–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è: ${time.toFixed(0)}–º—Å`;
        }

        async function getCommonsImageUrl(fileName) {
            const start = performance.now();
            const response = await fetch(`https://commons.wikimedia.org/w/api.php?action=query&titles=File:${encodeURIComponent(fileName)}&prop=imageinfo&iiprop=url&format=json&origin=*`);
            const data = await response.json();
            const pages = data.query.pages;
            const page = pages[Object.keys(pages)[0]];
            console.log(`Commons API time: ${(performance.now() - start).toFixed(0)}ms`);
            return page.imageinfo ? page.imageinfo[0].url : null;
        }

        async function loadImageWithFallback(url, element) {
            return new Promise((resolve, reject) => {
                element.classList.remove('loaded');
                element.onerror = () => {
                    const proxyUrl = `https://images.weserv.nl/?url=${encodeURIComponent(url)}`;
                    element.onerror = () => {
                        element.src = 'https://via.placeholder.com/300';
                        reject(new Error('Fallback failed'));
                    };
                    element.src = proxyUrl;
                };
                element.onload = () => {
                    element.classList.add('loaded');
                    resolve();
                };
                element.src = url;
            });
        }

        async function fetchPersonData(useRandom = true) {
            const start = performance.now();
            let query;

            // –ë–∞–∑–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –ø–æ–ª–∞ –∏ —Å—Ç–∞—Ç—É—Å–∞
            const genderFilter = settings.genderRatio.male === 50 && settings.genderRatio.female === 50
                ? `?person wdt:P21 ?gender. FILTER(?gender IN (wd:Q6581097, wd:Q6581072)).` // –ú—É–∂—á–∏–Ω–∞ –∏–ª–∏ –∂–µ–Ω—â–∏–Ω–∞
                : ''; // –ú–æ–∂–Ω–æ –¥–æ—Ä–∞–±–æ—Ç–∞—Ç—å –¥–ª—è –¥—Ä—É–≥–∏—Ö —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–π
            const statusFilter = settings.statusRatio.alive === 50 && settings.statusRatio.deceased === 50
                ? `OPTIONAL { ?person wdt:P570 ?deathDate. }` // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –¥–∞—Ç—ã —Å–º–µ—Ä—Ç–∏
                : '';

            if (useRandom && settings.superRandomPeople) {
                // –ú–µ–¥–ª–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º: ORDER BY RAND()
                query = `
                    SELECT ?person ?personLabel ?image ?country ?gender ?deathDate
                    WHERE {
                        ?person wdt:P31 wd:Q5;
                                wdt:P18 ?image;
                                wdt:P27 ?country.
                        ${genderFilter}
                        ${statusFilter}
                        ?person rdfs:label ?personLabel.
                        FILTER (LANG(?personLabel) = "en").
                    }
                    ORDER BY RAND()
                    LIMIT 1
                `;
            } else {
                // –ë—ã—Å—Ç—Ä—ã–π —Ä–µ–∂–∏–º: SAMPLE() –∏–ª–∏ OFFSET
                let offsetClause = '';
                let limit = settings.maxPeople;
                if (settings.dynamicOffset) {
                    const offset = Math.floor(Math.random() * settings.maxOffset);
                    offsetClause = `OFFSET ${offset}`;
                }

                if (settings.RandomPeople) {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º OFFSET –∏ LIMIT –≤–º–µ—Å—Ç–æ SAMPLE(), —Ç–∞–∫ –∫–∞–∫ SAMPLE() –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã–º
                    query = `
                        SELECT ?person ?personLabel ?image ?country ?gender ?deathDate
                        WHERE {
                            ?person wdt:P31 wd:Q5;
                                    wdt:P18 ?image;
                                    wdt:P27 ?country.
                            ${genderFilter}
                            ${statusFilter}
                            ?person rdfs:label ?personLabel.
                            FILTER (LANG(?personLabel) = "en").
                        }
                        ${offsetClause}
                        LIMIT ${limit}
                    `;
                }
            }

            const endpoint = 'https://query.wikidata.org/sparql';
            const url = `${endpoint}?query=${encodeURIComponent(query)}&format=json&nocache=${Date.now()}`;

            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 15000);

            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/sparql-results+json',
                        'User-Agent': 'SimplePhotoApp/1.0 (https://romanmod.github.io/personseei/; krv.mod@gmail.com)',
                    },
                    signal: controller.signal
                });

                clearTimeout(timeout);
                const data = await response.json();
                const list = data.results.bindings;

                console.log(`Wikidata query time: ${(performance.now() - start).toFixed(0)}ms (${useRandom ? 'random' : 'fast'})`);

                if (!list.length) throw new Error('No person found');

                // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–ª—è 50/50 –∂–∏–≤—ã—Ö/–º—ë—Ä—Ç–≤—ã—Ö –∏ –º—É–∂—á–∏–Ω/–∂–µ–Ω—â–∏–Ω
                const filteredList = list.filter(item => {
                    const isMale = item.gender?.value === 'http://www.wikidata.org/entity/Q6581097';
                    const isFemale = item.gender?.value === 'http://www.wikidata.org/entity/Q6581072';
                    const isAlive = !item.deathDate;
                    return (isMale || isFemale) && (isAlive || item.deathDate);
                });

                // –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é –ø–µ—Ä—Å–æ–Ω—É –∏–∑ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞
                if (filteredList.length === 0) throw new Error('No person matches filters');
                const randomIndex = Math.floor(Math.random() * filteredList.length);
                return filteredList[randomIndex];
            } catch (error) {
                throw error;
            }
        }

        function updateUI({ personLabel }) {
            const progress = document.getElementById('progress');
            const personName = document.getElementById('person-name');
            progress.textContent = '–§–æ—Ç–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ!';
            progress.classList.remove('loading', 'error');
            personName.textContent = personLabel.value;
        }

        function handleError(errorMessage) {
            const progress = document.getElementById('progress');
            const personImage = document.getElementById('person-image');
            const personName = document.getElementById('person-name');

            progress.textContent = errorMessage;
            progress.classList.add('error');
            progress.classList.remove('loading');
            personImage.src = 'https://via.placeholder.com/300';
            personName.textContent = '–¢–µ—Å—Ç–æ–≤–∏–π –ø–µ—Ä—Å–æ–Ω–∞–∂';
        }

        async function loadPerson(useRandom = true) {
            const startTime = performance.now();
            const mode = useRandom ? 'slow' : 'fast';
            
            const progress = document.getElementById('progress');
            const personImage = document.getElementById('person-image');
            const personName = document.getElementById('person-name');

            progress.textContent = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...';
            progress.classList.add('loading');
            progress.classList.remove('error');
            personImage.src = '';
            personName.textContent = '';
            personImage.classList.remove('loaded');

            try {
                const person = await fetchPersonData(useRandom);
                if (!person) throw new Error('No person found');

                const fileName = decodeURIComponent(person.image.value.split('/').pop());
                const imageUrl = await getCommonsImageUrl(fileName);
                if (!imageUrl) throw new Error('Invalid image');

                await loadImageWithFallback(imageUrl, personImage);
                updateUI(person);
                
                const totalTime = performance.now() - startTime;
                updateStats(mode, totalTime);
            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞:', error.message);
                let message = '–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è';

                if (error.message.includes('Timeout')) {
                    message = '–¢–∞–π–º-–∞—É—Ç –∑–∞–ø–∏—Ç—É –¥–æ Wikidata';
                } else if (error.message.includes('HTTP 400')) {
                    message = '–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π SPARQL-–∑–∞–ø–∏—Ç';
                } else if (error.message.includes('No person found')) {
                    message = '–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –¥–∞–Ω–∏—Ö –ø—Ä–æ –ª—é–¥–∏–Ω—É';
                } else if (error.message.includes('Invalid image')) {
                    message = '–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è';
                }

                handleError(message);
                
                const totalTime = performance.now() - startTime;
                document.getElementById(`time-${mode}`).textContent = 
                    `–ü–æ–º–∏–ª–∫–∞ –ø—ñ—Å–ª—è ${totalTime.toFixed(0)}–º—Å`;
            }
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–µ–π
        let sessionCount = 0;
        async function loadSession() {
            sessionCount = 0;
            while (sessionCount < settings.sessionPeople) {
                await loadPerson(false); // –ò—Å–ø–æ–ª—å–∑—É–µ–º –±—ã—Å—Ç—Ä—ã–π —Ä–µ–∂–∏–º –¥–ª—è —Å–µ—Å—Å–∏–∏
                sessionCount++;
                if (sessionCount < settings.sessionPeople) {
                    // –ñ–¥—ë–º 2 —Å–µ–∫—É–Ω–¥—ã –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π —Å–ª–µ–¥—É—é—â–µ–π –ø–µ—Ä—Å–æ–Ω—ã
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
            }
            document.getElementById('progress').textContent = `–°–µ—Å—ñ—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ (${settings.sessionPeople} –æ—Å—ñ–±)`;
        }

        window.onload = () => {
            loadSession();
        };
    </script>

</body>
</html>
