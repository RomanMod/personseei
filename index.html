<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="origin">
    <title>–ì—Ä–∞: –•—Ç–æ —Ü–µ?</title>
    <!-- –ü–æ–¥–∞–≤–ª–µ–Ω–∏–µ favicon -->
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-TQ5F8JW26S"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-TQ5F8JW26S');
    </script>
    <style>
        :root {
            --bg-color: #2c2c2e;
            --text-color: #e0e0e0;
            --button-bg: #3a3a3c;
            --button-hover: #4a4a4c;
            --button-active: #1c1c1e;
            --highlight-correct: #4caf50;
            --highlight-error: #f44336;
            --highlight-warning: #ff9800;
            --display-bg: #1c1c1e;
            --link-color: #40c4ff;
        }

        [data-theme="light"] {
            --bg-color: #f9f9f9;
            --text-color: #333;
            --button-bg: #d0d0d0;
            --button-hover: #b0b0b0;
            --button-active: #a0a0a0;
            --highlight-correct: #0288d1;
            --highlight-error: #d32f2f;
            --highlight-warning: #f57c00;
            --display-bg: #e0e0e0;
            --link-color: #0288d1;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            padding-top: 10vh;
        }

        h1 {
            font-size: 2em;
            margin-bottom: 20px;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        select, button {
            background-color: var(--button-bg);
            color: var(--text-color);
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s;
        }

        select:hover, button:hover {
            background-color: var(--button-hover);
        }

        select:active, button:active {
            background-color: var(--button-active);
        }

        .display-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .display {
            width: 300px;
            height: 300px;
            background-color: var(--display-bg);
            border-radius: 10px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .display img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            display: none;
        }

        .display img.visible {
            display: block;
        }

        .display .progress {
            font-size: 1.5em;
            font-weight: bold;
        }

        .display .closed-screen {
            background-color: var(--display-bg);
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
        }

        .new-photo-btn {
            background-color: var(--button-bg);
            color: var(--text-color);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s;
        }

        .new-photo-btn:hover {
            background-color: var(--button-hover);
        }

        .new-photo-btn:active {
            background-color: var(--button-active);
        }

        .info {
            text-align: center;
            margin-bottom: 20px;
            min-height: 60px;
        }

        .info a {
            color: var(--link-color);
            text-decoration: none;
        }

        .info a:hover {
            text-decoration: underline;
        }

        .info.warning {
            color: var(--highlight-warning);
        }

        .buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
            max-width: 400px;
        }

        .buttons button {
            padding: 20px;
            font-size: 1.5em;
            border-radius: 10px;
        }

        .buttons button.correct {
            background-color: var(--highlight-correct);
        }

        .buttons button.error {
            background-color: var(--highlight-error);
        }

        .buttons button.warning {
            border: 2px solid var(--highlight-warning);
        }

        .check-btn {
            padding: 15px 30px;
            font-size: 1.2em;
            border-radius: 10px;
            margin: 10px 0;
        }

        .stats {
            margin-top: 20px;
            padding: 15px;
            background-color: var(--button-bg);
            border-radius: 10px;
            text-align: left;
        }

        .alien {
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
        }
    </style>
</head>
<body data-theme="dark">
    <h1 data-i18n="title">–ì—Ä–∞: –•—Ç–æ —Ü–µ?</h1>
    <div class="controls">
        <select id="theme" onchange="changeTheme()">
            <option value="dark" data-i18n="theme-dark">–ù—ñ—á</option>
            <option value="light" data-i18n="theme-light">–î–µ–Ω—å</option>
        </select>
        <select id="language" onchange="changeLanguage()">
            <option value="uk" data-i18n="lang-uk">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</option>
            <option value="ru" data-i18n="lang-ru">–†—É—Å—Å–∫–∏–π</option>
            <option value="en" data-i18n="lang-en">English</option>
            <option value="alien" data-i18n="lang-alien">üëΩ –Ü–Ω–Ω–æ–ø–ª–∞–Ω–µ—Ç–Ω–∏–π</option>
        </select>
        <select id="mode" onchange="changeMode()">
            <option value="open" data-i18n="mode-open">–í—ñ–¥–∫—Ä–∏—Ç–∏–π</option>
            <option value="closed" data-i18n="mode-closed">–ó–∞–∫—Ä–∏—Ç–∏–π</option>
        </select>
    </div>
    <div class="display-container">
        <div class="display">
            <img id="person-image" alt="Person">
            <div id="closed-screen" class="closed-screen"></div>
            <div id="progress" class="progress">0%</div>
        </div>
        <button id="new-photo-btn" class="new-photo-btn" data-i18n="new-photo">–ó–Ω–∞–π—Ç–∏ —ñ–Ω—à–µ —Ñ–æ—Ç–æ</button>
    </div>
    <div id="info" class="info"></div>
    <div class="buttons" id="answer-buttons"></div>
    <button id="check-btn" class="check-btn" data-i18n="check">–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏</button>
    <button id="next-btn" class="check-btn" data-i18n="next" style="display: none;">–î–∞–ª—ñ</button>
    <div class="stats">
        <div data-i18n="stats-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</div>
        <div id="stats-total" data-i18n="stats-total">–í—Å—å–æ–≥–æ –ø–∏—Ç–∞–Ω—å: 0</div>
        <div id="stats-correct" data-i18n="stats-correct">–ü—Ä–∞–≤–∏–ª—å–Ω–∏—Ö: 0</div>
        <div id="stats-incorrect" data-i18n="stats-incorrect">–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏—Ö: 0</div>
    </div>

    <script>
        // –ß–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        const imageBlacklist = [
            'Lithuanian_swimming_squad_at_2012_Olympic_Games.jpg'
        ];

        // Settings
        const settings = {
            maxAttempts: 5,
            birthYearFilter: 1950,
            countryMap: { 'ua': 'Q212', 'us': 'Q30' },
            selectedCountries: ['ua', 'us'],
            strictCountryFilter: false
        };

        // Localization
        const i18n = {
            uk: {
                title: "–ì—Ä–∞: –•—Ç–æ —Ü–µ?",
                'theme-dark': "–ù—ñ—á", 'theme-light': "–î–µ–Ω—å",
                'lang-uk': "–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞", 'lang-ru': "–†—É—Å—Å–∫–∏–π", 'lang-en': "English", 'lang-alien': "üëΩ –Ü–Ω–Ω–æ–ø–ª–∞–Ω–µ—Ç–Ω–∏–π",
                'mode-open': "–í—ñ–¥–∫—Ä–∏—Ç–∏–π", 'mode-closed': "–ó–∞–∫—Ä–∏—Ç–∏–π",
                check: "–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏", next: "–î–∞–ª—ñ", 'new-photo': "–ó–Ω–∞–π—Ç–∏ —ñ–Ω—à–µ —Ñ–æ—Ç–æ",
                'stats-title': "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:", 'stats-total': "–í—Å—å–æ–≥–æ –ø–∏—Ç–∞–Ω—å: ", 'stats-correct': "–ü—Ä–∞–≤–∏–ª—å–Ω–∏—Ö: ", 'stats-incorrect': "–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏—Ö: ",
                alive: "–ñ–∏–≤–∏–π", deceased: "–ú–µ—Ä—Ç–≤–∏–π", male: "–ß–æ–ª–æ–≤—ñ–∫", female: "–ñ—ñ–Ω–∫–∞",
                closed: "–ó–∞–∫—Ä–∏—Ç–∏–π —Ä–µ–∂–∏–º", error: "–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö",
                incomplete: "–í–∏–±–µ—Ä—ñ—Ç—å —É—Å—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ!"
            },
            ru: {
                title: "–ò–≥—Ä–∞: –ö—Ç–æ —ç—Ç–æ?",
                'theme-dark': "–ù–æ—á—å", 'theme-light': "–î–µ–Ω—å",
                'lang-uk': "–£–∫—Ä–∞–∏–Ω—Å–∫–∏–π", 'lang-ru': "–†—É—Å—Å–∫–∏–π", 'lang-en': "–ê–Ω–≥–ª–∏–π—Å–∫–∏–π", 'lang-alien': "üëΩ –ò–Ω–æ–ø–ª–∞–Ω–µ—Ç–Ω—ã–π",
                'mode-open': "–û—Ç–∫—Ä—ã—Ç—ã–π", 'mode-closed': "–ó–∞–∫—Ä—ã—Ç—ã–π",
                check: "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å", next: "–î–∞–ª–µ–µ", 'new-photo': "–ù–∞–π—Ç–∏ –¥—Ä—É–≥–æ–µ —Ñ–æ—Ç–æ",
                'stats-title': "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:", 'stats-total': "–í—Å–µ–≥–æ –≤–æ–ø—Ä–æ—Å–æ–≤: ", 'stats-correct': "–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö: ", 'stats-incorrect': "–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö: ",
                alive: "–ñ–∏–≤", deceased: "–ú–µ—Ä—Ç–≤", male: "–ú—É–∂—á–∏–Ω–∞", female: "–ñ–µ–Ω—â–∏–Ω–∞",
                closed: "–ó–∞–∫—Ä—ã—Ç—ã–π —Ä–µ–∂–∏–º", error: "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö",
                incomplete: "–í—ã–±–µ—Ä–∏—Ç–µ –≤—Å–µ –æ—Ç–≤–µ—Ç—ã!"
            },
            en: {
                title: "Game: Who is it?",
                'theme-dark': "Night", 'theme-light': "Day",
                'lang-uk': "Ukrainian", 'lang-ru': "Russian", 'lang-en': "English", 'lang-alien': "üëΩ Alien",
                'mode-open': "Open", 'mode-closed': "Closed",
                check: "Check", next: "Next", 'new-photo': "Find another photo",
                'stats-title': "Statistics:", 'stats-total': "Total questions: ", 'stats-correct': "Correct: ", 'stats-incorrect': "Incorrect: ",
                alive: "Alive", deceased: "Deceased", male: "Male", female: "Female",
                closed: "Closed mode", error: "Data loading error",
                incomplete: "Select all answers!"
            },
            alien: {
                title: "‚ä∏‚äª‚ä∏: ‚äΩ‚ä∏‚äª ‚äΩ‚ä∏‚ä∏?",
                'theme-dark': "‚ä∏‚äª‚ä∏", 'theme-light': "‚äª‚ä∏‚äª",
                'lang-uk': "‚äª‚ä∏‚ä∏", 'lang-ru': "‚ä∏‚äª‚ä∏", 'lang-en': "‚ä∏‚ä∏‚äª", 'lang-alien': "üëΩ ‚ä∏‚äª‚äª",
                'mode-open': "‚äª‚ä∏‚ä∏‚äª", 'mode-closed': "‚ä∏‚äª‚ä∏‚äª",
                check: "‚ä∏‚äª‚ä∏‚äª", next: "‚äª‚ä∏‚äª", 'new-photo': "‚ä∏‚äª‚ä∏ ‚äª‚ä∏‚äª",
                'stats-title': "‚ä∏‚äª‚ä∏‚äª:", 'stats-total': "‚äª‚ä∏‚äª ‚ä∏‚äª‚ä∏: ", 'stats-correct': "‚ä∏‚äª‚ä∏: ", 'stats-incorrect': "‚äª‚ä∏‚äª: ",
                alive: "‚ä∏‚äª‚ä∏", deceased: "‚äª‚ä∏‚äª", male: "‚ä∏‚äª‚ä∏", female: "‚äª‚ä∏‚äª",
                closed: "‚ä∏‚äª‚ä∏‚äª ‚äª‚ä∏‚äª", error: "‚ä∏‚äª‚ä∏ ‚äª‚ä∏‚äª",
                incomplete: "‚ä∏‚äª‚ä∏ ‚äª‚ä∏‚äª!"
            }
        };

        // Game state
        const state = {
            theme: 'dark',
            language: 'uk',
            mode: 'open',
            person: null,
            answers: { status: null, gender: null },
            stats: { total: 0, correct: 0, incorrect: 0 },
            progress: 0,
            checked: false
        };

        // Cache
        let cache = JSON.parse(localStorage.getItem('personCache')) || [];

        // Logging
        function log(message, type = 'info') {
            const types = { info: 'log', error: 'error', warn: 'warn' };
            console[types[type]](`[Game] ${new Date().toISOString()} - ${message}`);
        }

        // GA4 events
        function sendGA4Event(eventName, params) {
            gtag('event', eventName, params);
            log(`GA4 event sent: ${eventName}`, 'info');
        }

        // Debounced UI update
        let uiUpdatePending = false;
        function updateUI() {
            if (uiUpdatePending) return;
            uiUpdatePending = true;
            requestAnimationFrame(() => {
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.dataset.i18n;
                    el.textContent = i18n[state.language][key] + (key.includes('stats-') ? state.stats[key.split('-')[1]] : '');
                });
                document.getElementById('progress').textContent = `${state.progress}%`;
                document.getElementById('closed-screen').textContent = state.mode === 'closed' && !state.checked ? i18n[state.language].closed : '';
                renderInfo();
                renderButtons();
                updateStats();
                uiUpdatePending = false;
            });
        }

        // Idle callback with setTimeout fallback
        function idleCallback(task, timeout = 100) {
            return new Promise(resolve => {
                if ('requestIdleCallback' in window) {
                    requestIdleCallback(() => {
                        task();
                        resolve();
                    }, { timeout });
                } else {
                    setTimeout(() => {
                        task();
                        resolve();
                    }, timeout);
                }
            });
        }

        // Change theme
        function changeTheme() {
            state.theme = document.getElementById('theme').value;
            document.body.dataset.theme = state.theme;
            sendGA4Event('theme_change', { theme: state.theme });
            updateUI();
        }

        // Change language
        function changeLanguage() {
            state.language = document.getElementById('language').value;
            document.body.classList.toggle('alien', state.language === 'alien');
            updateUI();
            sendGA4Event('language_change', { language: state.language });
        }

        // Change mode
        function changeMode() {
            state.mode = document.getElementById('mode').value;
            resetAnswers();
            renderButtons();
            updateUI();
            sendGA4Event('mode_change', { mode: state.mode });
        }

        // Render buttons
        function renderButtons() {
            const buttonsDiv = document.getElementById('answer-buttons');
            buttonsDiv.innerHTML = '';
            const buttons = state.mode === 'closed' ? [
                { id: 'alive', text: 'alive', type: 'status' },
                { id: 'deceased', text: 'deceased', type: 'status' },
                { id: 'male', text: 'male', type: 'gender' },
                { id: 'female', text: 'female', type: 'gender' }
            ] : [
                { id: 'alive', text: 'alive', type: 'status' },
                { id: 'deceased', text: 'deceased', type: 'status' }
            ];

            buttons.forEach(btn => {
                const button = document.createElement('button');
                button.textContent = i18n[state.language][btn.text];
                button.dataset.type = btn.type;
                button.dataset.value = btn.id;
                if (state.answers[btn.type] === btn.id) {
                    button.classList.add(state.checked && isCorrect(btn.type, btn.id) ? 'correct' : 'error');
                } else if (!state.checked && !state.answers[btn.type]) {
                    button.classList.add('warning');
                }
                button.onclick = () => selectAnswer(btn.type, btn.id);
                buttonsDiv.appendChild(button);
            });
        }

        // Select answer
        function selectAnswer(type, value) {
            if (state.checked) return;
            state.answers[type] = value;
            renderButtons();
            log(`Answer selected: ${type} = ${value}`);
            updateUI();
        }

        // Check answer
        function checkAnswer() {
            if (state.checked || !state.person) return;
            const requiredAnswers = state.mode === 'closed' ? ['status', 'gender'] : ['status'];
            if (requiredAnswers.some(type => !state.answers[type])) {
                log('Incomplete answers', 'warn');
                const infoDiv = document.getElementById('info');
                infoDiv.textContent = i18n[state.language].incomplete;
                infoDiv.classList.add('warning');
                setTimeout(() => {
                    infoDiv.textContent = '';
                    infoDiv.classList.remove('warning');
                }, 2000);
                return;
            }

            state.checked = true;
            state.stats.total++;
            let correct = true;

            requiredAnswers.forEach(type => {
                if (!isCorrect(type, state.answers[type])) {
                    correct = false;
                    state.stats.incorrect++;
                } else {
                    state.stats.correct++;
                }
            });

            sendGA4Event('answer_check', {
                mode: state.mode,
                correct: correct,
                status_answer: state.answers.status,
                gender_answer: state.answers.gender || null
            });

            document.getElementById('check-btn').style.display = 'none';
            document.getElementById('next-btn').style.display = 'block';
            updateUI();
        }

        // Check correctness
        function isCorrect(type, value) {
            if (!state.person) return false;
            if (type === 'status') {
                return (value === 'alive' && !state.person.deathDate) ||
                       (value === 'deceased' && state.person.deathDate);
            }
            if (type === 'gender') {
                return (value === 'male' && state.person.gender?.value.includes('Q6581097')) ||
                       (value === 'female' && state.person.gender?.value.includes('Q6581072'));
            }
            return false;
        }

        // Reset answers
        function resetAnswers() {
            state.answers = { status: null, gender: null };
            state.checked = false;
            document.getElementById('check-btn').style.display = 'block';
            document.getElementById('next-btn').style.display = 'none';
            renderButtons();
        }

        // Render info
        function renderInfo() {
            const infoDiv = document.getElementById('info');
            if (!state.person || !state.checked) {
                infoDiv.innerHTML = '';
                return;
            }
            const { personLabel, birthDate, deathDate, person } = state.person;
            const birthDateText = birthDate ? new Date(birthDate.value).toLocaleDateString('uk-UA') : '???';
            const statusText = i18n[state.language][deathDate ? 'deceased' : 'alive'];
            const genderText = i18n[state.language][state.person.gender?.value.includes('Q6581097') ? 'male' : 'female'];
            const wikidataLink = `<a href="${person.value}" target="_blank">${personLabel.value}</a>`;
            infoDiv.innerHTML = `${wikidataLink} (${genderText}, ${statusText}, ${birthDateText})`;
        }

        // Update stats
        function updateStats() {
            document.getElementById('stats-total').textContent = `${i18n[state.language]['stats-total']}${state.stats.total}`;
            document.getElementById('stats-correct').textContent = `${i18n[state.language]['stats-correct']}${state.stats.correct}`;
            document.getElementById('stats-incorrect').textContent = `${i18n[state.language]['stats-incorrect']}${state.stats.incorrect}`;
        }

        // Get Commons image URL
        async function getCommonsImageUrl(fileName) {
            if (imageBlacklist.includes(fileName)) {
                log(`Blocked image in getCommonsImageUrl: ${fileName}`, 'warn');
                return null;
            }
            try {
                const response = await fetch(`https://commons.wikimedia.org/w/api.php?action=query&titles=File:${encodeURIComponent(fileName)}&prop=imageinfo&iiprop=url&format=json&origin=*`);
                if (!response.ok) throw new Error(`Commons API error: ${response.status}`);
                const data = await response.json();
                const pages = data.query.pages;
                const page = pages[Object.keys(pages)[0]];
                if (!page.imageinfo) throw new Error(`No imageinfo for file: ${fileName}`);
                return page.imageinfo[0].url;
            } catch (error) {
                log(`Failed to fetch Commons image for ${fileName}: ${error.message}`, 'error');
                return null;
            }
        }

        // Load image with fallback
        async function loadImageWithFallback(url, element) {
            return new Promise((resolve, reject) => {
                const proxyUrl = `https://images.weserv.nl/?url=${encodeURIComponent(url)}`;
                log(`Loading image via proxy: ${proxyUrl}`);
                const img = new Image();
                img.onload = () => {
                    element.src = proxyUrl;
                    element.classList.add('visible');
                    log(`Image loaded: ${proxyUrl}`);
                    resolve();
                };
                img.onerror = () => {
                    log(`Image load failed: ${proxyUrl}`, 'error');
                    reject(new Error(`Image load failed: ${proxyUrl}`));
                };
                img.src = proxyUrl;
            });
        }

        // Fetch person data
        async function fetchPersonData() {
            // –õ–æ–≥–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫—ç—à–∞
            log(`Cache size: ${cache.length}, contents: ${JSON.stringify(cache.map(p => decodeURIComponent(p.image.value.split('/').pop())))}`, 'info');

            // –§–∏–ª—å—Ç—Ä—É–µ–º –∫—ç—à –æ—Ç —á–µ—Ä–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞
            cache = cache.filter(person => {
                const fileName = decodeURIComponent(person.image.value.split('/').pop());
                const isBlacklisted = imageBlacklist.includes(fileName);
                if (isBlacklisted) {
                    log(`Removing blacklisted image from cache: ${fileName}`, 'warn');
                }
                return !isBlacklisted;
            });
            localStorage.setItem('personCache', JSON.stringify(cache));

            if (cache.length > 0) {
                log('Using cached person');
                const person = cache[Math.floor(Math.random() * cache.length)];
                const fileName = decodeURIComponent(person.image.value.split('/').pop());
                if (imageBlacklist.includes(fileName)) {
                    log(`Blocked cached image: ${fileName}`, 'warn');
                    throw new Error(`Blacklisted image: ${fileName}`);
                }
                return person;
            }

            const maxOffset = 1000;
            const offset = Math.floor(Math.random() * maxOffset);
            const genderFilter = 'FILTER(?gender IN (wd:Q6581097, wd:Q6581072))';
            const birthDateFilter = `FILTER(?birthDate >= "${settings.birthYearFilter}-01-01"^^xsd:dateTime).`;
            const countryFilter = settings.selectedCountries === 'all' ? '' :
                `FILTER(?country IN (${settings.selectedCountries.map(code => `wd:${settings.countryMap[code]}`).join(', ')})).`;
            const query = `
                SELECT ?person ?personLabel ?image ?gender ?deathDate ?birthDate ?country
                WHERE {
                    ?person wdt:P31 wd:Q5;
                            wdt:P18 ?image;
                            wdt:P21 ?gender;
                            wdt:P569 ?birthDate.
                    ${settings.strictCountryFilter ? '' : 'OPTIONAL'} { ?person wdt:P27 ?country }.
                    ${genderFilter}.
                    OPTIONAL { ?person wdt:P570 ?deathDate }.
                    ${birthDateFilter}
                    ${settings.strictCountryFilter ? countryFilter : ''}
                    ?person rdfs:label ?personLabel.
                    FILTER (LANG(?personLabel) = "en").
                }
                OFFSET ${offset}
                LIMIT 1
            `;
            const url = `https://query.wikidata.org/sparql?query=${encodeURIComponent(query)}&format=json`;
            try {
                state.progress = 10;
                updateUI();
                const response = await fetch(url, {
                    headers: { 'Accept': 'application/sparql-results+json' }
                });
                state.progress = 30;
                if (!response.ok) {
                    const text = await response.text();
                    log(`Wikidata error: ${response.status} - ${text}`, 'error');
                    throw new Error(`HTTP ${response.status}: ${text}`);
                }
                const data = await response.json();
                const person = data.results.bindings[0];
                if (!person) throw new Error('No person found');
                log(`Person fetched: ${person.personLabel.value}`);
                const fileName = decodeURIComponent(person.image.value.split('/').pop());
                if (imageBlacklist.includes(fileName)) {
                    log(`Blocked fetched image: ${fileName}`, 'warn');
                    throw new Error(`Blacklisted image: ${fileName}`);
                }
                cache.push(person);
                localStorage.setItem('personCache', JSON.stringify(cache.slice(-10)));
                return person;
            } catch (error) {
                log(`Wikidata query failed: ${error.message}`, 'error');
                throw error;
            }
        }

        // Load person
        async function loadPerson() {
            state.person = null;
            state.checked = false;
            resetAnswers();
            const personImage = document.getElementById('person-image');
            personImage.classList.remove('visible');
            personImage.src = '';
            state.progress = 0;
            updateUI();

            let attempts = 0;
            while (attempts < settings.maxAttempts) {
                try {
                    state.progress = 10;
                    const person = await fetchPersonData();
                    state.progress = 50;
                    const fileName = decodeURIComponent(person.image.value.split('/').pop());
                    if (imageBlacklist.includes(fileName)) {
                        log(`Blocked image in loadPerson: ${fileName}`, 'warn');
                        throw new Error(`Blacklisted image: ${fileName}`);
                    }
                    const imageUrl = await getCommonsImageUrl(fileName);
                    if (!imageUrl) throw new Error(`Invalid image: ${fileName}`);
                    state.progress = 80;
                    await loadImageWithFallback(imageUrl, personImage);
                    state.person = person;
                    state.progress = 100;
                    updateUI();
                    sendGA4Event('person_loaded', { person: person.personLabel.value });
                    break;
                } catch (error) {
                    attempts++;
                    log(`Load person attempt ${attempts} failed: ${error.message}`, 'error');
                    if (attempts === settings.maxAttempts) {
                        state.progress = 0;
                        document.getElementById('info').textContent = i18n[state.language].error;
                        sendGA4Event('load_error', { error: error.message });
                        updateUI();
                        return;
                    }
                    await idleCallback(() => {}, 100); // –ò—Å–ø–æ–ª—å–∑—É–µ–º requestIdleCallback —Å fallback
                }
            }
        }

        // Initialization
        window.onload = () => {
            // –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ –æ—Ç —á–µ—Ä–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
            const initialCacheSize = cache.length;
            cache = cache.filter(person => {
                const fileName = decodeURIComponent(person.image.value.split('/').pop());
                const isBlacklisted = imageBlacklist.includes(fileName);
                if (isBlacklisted) {
                    log(`Removing blacklisted image from initial cache: ${fileName}`, 'warn');
                }
                return !isBlacklisted;
            });
            if (cache.length !== initialCacheSize) {
                log(`Cache cleaned, removed ${initialCacheSize - cache.length} blacklisted images`, 'info');
            }
            localStorage.setItem('personCache', JSON.stringify(cache));

            document.getElementById('check-btn').onclick = checkAnswer;
            document.getElementById('next-btn').onclick = () => {
                resetAnswers();
                loadPerson();
                document.getElementById('check-btn').style.display = 'block';
                document.getElementById('next-btn').style.display = 'none';
                sendGA4Event('next_person', { action: 'next_clicked' });
                log('Next person clicked');
            };
            document.getElementById('new-photo-btn').onclick = () => {
                resetAnswers();
                loadPerson();
                sendGA4Event('new_photo', { action: 'find_another_photo' });
                log('Find another photo clicked');
            };
            loadPerson();
            updateUI();
            sendGA4Event('game_start', { language: state.language, mode: state.mode, theme: state.theme });
        };
    </script>
</body>
</html>
